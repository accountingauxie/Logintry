<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PO Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
      body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; font-size: 0.9rem; }
      
      /* Card Styling */
      .card { border: none; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
      
      /* Table Styling */
      .table thead th { 
        background-color: #f8f9fa; color: #6c757d; font-weight: 600; 
        font-size: 0.8rem; border-bottom: 2px solid #e9ecef; text-transform: uppercase;
      }
      .table td { vertical-align: middle; color: #495057; }
      
      /* Modal Styling khusus Bill Entry */
      .bill-header-alert {
        background-color: #d1e7dd; color: #0f5132; 
        padding: 10px 15px; border-radius: 5px; font-weight: 600;
        margin-bottom: 15px; display: flex; align-items: center;
      }
      .bill-header-alert i { margin-right: 8px; }
      
      /* File Upload & View Section */
      .file-section {
        background-color: #fff; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px;
      }
      .view-doc-box {
        background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 5px;
        padding: 10px; text-align: center; height: 100%; display: flex; 
        flex-direction: column; justify-content: center; align-items: center;
      }
      
      /* Item Table inside Modal */
      .modal-table th { background-color: #fff !important; font-size: 0.75rem; }
      .modal-table td { font-size: 0.85rem; padding: 10px; }
      .bg-light-input { background-color: #f8f9fa; border: 1px solid #ced4da; }

      /* Footer Totals */
      .total-box {
        background-color: #fff; padding: 15px; border-radius: 5px;
      }
      .total-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
      .grand-total { font-size: 1.2rem; font-weight: bold; color: #0f5132; border-top: 1px dashed #ccc; padding-top: 10px; margin-top: 5px; }

      /* Loader */
      #loader { display: flex; justify-content: center; margin-top: 50px; }
    </style>
</head>
<body>

    <div class="container-fluid py-4 px-4">
      
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4><i class="fas fa-file-invoice me-2"></i>Dashboard PO Purchase</h4>
        <button class="btn btn-light btn-sm shadow-sm border" onclick="fetchData()">
          <i class="fas fa-sync"></i> Refresh
        </button>
      </div>

      <div class="card p-3 mb-3">
        <input type="text" id="searchInput" class="form-control" placeholder="Search Vendor, PO ID, or Invoice...">
      </div>

      <div class="card p-4">
        <div id="loader">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>
        
        <div class="table-responsive">
          <table class="table table-hover d-none" id="dataTable">
            <thead>
              <tr>
                <th>VENDOR</th>
                <th>ID PO</th>
                <th>INVOICE NO</th>
                <th>INVOICE DATE</th>
                <th>DUE DATE</th>
                <th class="text-end">INV TOTAL</th>
                <th class="text-center">ACTION</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="modal fade" id="billModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
      <div class="modal-dialog modal-xl">
        <div class="modal-content" style="background-color: #f4f6f9;">
          
          <div class="modal-header bg-white border-bottom-0 pb-0">
            <div>
              <h5 class="modal-title fw-bold"><i class="fas fa-file-invoice-dollar text-success me-2"></i>Bill Entry / Detail</h5>
              <p class="text-muted small mb-2">PO Ref: <span id="modalPoRef" class="fw-bold text-dark"></span></p>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            
            <div class="bill-header-alert">
              <i class="fas fa-check-circle"></i> <span id="modalStatusText">Ready to Import.</span>
            </div>

            <form id="billForm">
              <div class="card p-3 mb-3">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label small text-muted fw-bold">VENDOR NAME</label>
                    <input type="text" class="form-control fw-bold" id="modalVendor" readonly style="background-color: #fff; border:none; padding-left:0;">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label small text-muted fw-bold">INV NUMBER <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="modalInvNo">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label small text-muted fw-bold">INV DATE</label>
                    <input type="date" class="form-control" id="modalInvDate">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label small text-muted fw-bold">DUE DATE</label>
                    <input type="date" class="form-control" id="modalDueDate">
                  </div>
                  <div class="col-md-2">
                    <label class="form-label small text-muted fw-bold">TAX MODE</label>
                    <select class="form-select" id="modalTaxMode">
                      <option value="Tax Exclusive">Tax Exclusive</option>
                      <option value="Tax Inclusive">Tax Inclusive</option>
                      <option value="No Tax">No Tax</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="card p-3 mb-3">
                <div class="row">
                  <div class="col-md-9 border-end">
                    <label class="fw-bold text-success mb-2"><i class="fas fa-paperclip"></i> UPLOAD INVOICE</label>
                    <div class="input-group mb-2">
                      <input type="file" class="form-control" id="inputGroupFile01" disabled> </div>
                    <small class="text-muted">Fitur upload belum aktif (gunakan link GDrive di sheet).</small>
                  </div>
                  
                  <div class="col-md-3">
                    <div class="view-doc-box">
                      <small class="text-muted mb-2 text-uppercase fw-bold" style="font-size: 0.7rem;">Current File</small>
                      <div id="viewDocContainer">
                        </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card p-0 mb-3 overflow-hidden">
                <div class="table-responsive">
                  <table class="table modal-table table-borderless mb-0">
                    <thead class="border-bottom">
                      <tr>
                        <th style="width: 5%;">#</th>
                        <th style="width: 10%;">TYPE</th>
                        <th style="width: 30%;">ITEM DETAILS</th>
                        <th>SPEC NOTE</th>
                        <th class="text-end">QTY</th>
                        <th class="text-end">PRICE</th>
                        <th class="text-end">DISC</th>
                        <th class="text-end">AMOUNT</th>
                      </tr>
                    </thead>
                    <tbody id="modalItemsBody" class="bg-white">
                      </tbody>
                  </table>
                </div>
              </div>

              <div class="row">
                <div class="col-md-7">
                  <div class="card p-3 h-100">
                    <label class="form-label small text-muted fw-bold">INTERNAL NOTES</label>
                    <textarea class="form-control" rows="4" placeholder="Catatan internal..." disabled></textarea>
                  </div>
                </div>
                <div class="col-md-5">
                  <div class="total-box shadow-sm">
                    <div class="total-row">
                      <span>Subtotal (DPP)</span>
                      <span id="txtSubtotal" class="fw-bold">0</span>
                    </div>
                    <div class="total-row">
                      <span>PPN (11%)</span>
                      <span id="txtPPN">0</span>
                    </div>
                    <div class="total-row align-items-center">
                      <span>Adjustment</span>
                      <input type="number" class="form-control form-control-sm text-end" style="width: 100px;" value="0" disabled>
                    </div>
                    <div class="total-row grand-total">
                      <span>GRAND TOTAL</span>
                      <span id="txtGrandTotal">0</span>
                    </div>
                  </div>
                </div>
              </div>

            </form>
          </div>

          <div class="modal-footer bg-white">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-info text-white"><i class="fas fa-file-export"></i> Import to Xero</button>
            <button type="button" class="btn btn-warning text-white fw-bold" onclick="submitEdit()">
              <i class="fas fa-edit"></i> Save / Edit Bill
            </button>
          </div>

        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // ==========================================
      // GANTI DENGAN URL WEB APP KAMU
      // ==========================================
      const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbww5AlasQStBrqGgmjtVZCVWTvk-S2c7rVqm6lxdXvyc8qwoBhRBQJeGj4dXc7kpQ41Hg/exec"; 
      
      let globalDataRaw = [];
      let globalGroupedData = {}; // Object untuk menyimpan data yg sudah di group by ID_PO
      const billModal = new bootstrap.Modal(document.getElementById('billModal'));
      let currentEditingId = "";

      document.addEventListener('DOMContentLoaded', fetchData);

      // --- 1. FETCH DATA & GROUPING ---
      function fetchData() {
        document.getElementById('loader').style.display = 'flex';
        document.getElementById('dataTable').classList.add('d-none');
        
        fetch(APPS_SCRIPT_URL)
          .then(response => response.json())
          .then(data => {
            globalDataRaw = data;
            processData(data); // Grouping Data
            document.getElementById('loader').style.display = 'none';
            document.getElementById('dataTable').classList.remove('d-none');
          })
          .catch(error => {
            console.error(error);
            alert("Gagal koneksi ke database.");
          });
      }

      function processData(rawData) {
        globalGroupedData = {};
        
        rawData.forEach(row => {
          if (!globalGroupedData[row.id_po]) {
            // Inisialisasi Header PO jika belum ada
            globalGroupedData[row.id_po] = {
              id_po: row.id_po,
              vendor: row.vendor,
              invoice_no: row.invoice_no,
              invoice_date: row.invoice_date,
              due_date: row.due_date,
              tax_mode: row.tax_mode,
              status: row.status,
              pdf_url: row.pdf_url,
              grand_total: 0, // Akan dihitung ulang sum items
              items: []
            };
          }
          // Push Item ke array items
          globalGroupedData[row.id_po].items.push({
            type: row.type_prod,
            desc: row.item_desc,
            spec: row.spec_note,
            qty: parseNumber(row.qty),
            price: parseNumber(row.unit_price),
            disc: parseNumber(row.disc),
            amount: parseNumber(row.amount),
            ppn: parseNumber(row.ppn)
          });
        });

        renderList(globalGroupedData);
      }

      // --- 2. RENDER LIST UTAMA ---
      function renderList(groupedData) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        const poKeys = Object.keys(groupedData);

        poKeys.forEach(key => {
          const po = groupedData[key];
          
          // Hitung Grand Total dari Items untuk tampilan list (atau pakai data raw sheet)
          const totalAmount = po.items.reduce((sum, item) => sum + item.amount + item.ppn, 0);

          let actionBtn = '';
          // Cek Status untuk tombol Action
          if (po.status === 'Billed') {
             // Tombol Edit yang membuka Modal Detail
            actionBtn = `<button class="btn btn-sm btn-outline-primary" onclick="openModal('${po.id_po}')">
                           <i class="fas fa-edit"></i> Edit
                         </button>`;
          } else {
            // Tombol Lock tapi tetap bisa View Detail (Opsional: ganti onclick jadi openModal tapi mode readonly)
            actionBtn = `<button class="btn btn-sm btn-light text-muted border" onclick="openModal('${po.id_po}')">
                           <i class="fas fa-lock"></i> Locked
                         </button>`;
          }

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="fw-bold text-dark">${po.vendor}</td>
            <td class="text-primary">${po.id_po}</td>
            <td>${po.invoice_no || '-'}</td>
            <td>${formatDateDisplay(po.invoice_date)}</td>
            <td>${formatDateDisplay(po.due_date)}</td>
            <td class="text-end fw-bold">${formatCurrency(totalAmount)}</td>
            <td class="text-center">${actionBtn}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      // --- 3. OPEN MODAL DETAIL (Bill Entry View) ---
      function openModal(id_po) {
        const po = globalGroupedData[id_po];
        currentEditingId = id_po;

        // Isi Header Form
        document.getElementById('modalPoRef').innerText = po.id_po;
        document.getElementById('modalVendor').value = po.vendor;
        document.getElementById('modalInvNo').value = po.invoice_no;
        document.getElementById('modalInvDate').value = parseDateForInput(po.invoice_date);
        document.getElementById('modalDueDate').value = parseDateForInput(po.due_date);
        document.getElementById('modalTaxMode').value = po.tax_mode || "Tax Exclusive";
        
        // Status Text
        const statusText = document.getElementById('modalStatusText');
        statusText.innerText = (po.status === 'Billed') ? "Ready to Import / Edit." : `Status: ${po.status}`;
        
        // Logika Tombol File
        const fileContainer = document.getElementById('viewDocContainer');
        if (po.pdf_url && po.pdf_url.length > 5) {
          fileContainer.innerHTML = `
            <a href="${po.pdf_url}" target="_blank" class="btn btn-outline-danger btn-sm w-100 fw-bold">
               <i class="fas fa-file-pdf"></i> View Document
            </a>`;
        } else {
          fileContainer.innerHTML = `<span class="text-muted small fw-bold"><i class="fas fa-times-circle"></i> No File</span>`;
        }

        // Render Items Table & Calculate Totals
        const itemBody = document.getElementById('modalItemsBody');
        itemBody.innerHTML = '';
        
        let subTotal = 0;
        let totalPPN = 0;

        po.items.forEach((item, idx) => {
          subTotal += item.amount;
          totalPPN += item.ppn;

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="checkbox" checked disabled></td>
            <td><span class="badge bg-light text-dark border">${item.type || 'Item'}</span></td>
            <td>
              <div class="fw-bold">${item.desc}</div>
              <small class="text-muted">Code: ${idx+1}</small>
            </td>
            <td><input type="text" class="form-control form-control-sm bg-light-input" value="${item.spec || '-'}" readonly></td>
            <td class="text-end fw-bold">${item.qty}</td>
            <td class="text-end">${formatCurrency(item.price)}</td>
            <td class="text-end text-danger">${item.disc > 0 ? formatCurrency(item.disc) : '-'}</td>
            <td class="text-end fw-bold">${formatCurrency(item.amount)}</td>
          `;
          itemBody.appendChild(tr);
        });

        // Set Totals Footer
        document.getElementById('txtSubtotal').innerText = formatCurrency(subTotal);
        document.getElementById('txtPPN').innerText = formatCurrency(totalPPN);
        document.getElementById('txtGrandTotal').innerText = formatCurrency(subTotal + totalPPN);

        // Disable Save Button if NOT Billed
        const saveBtn = document.querySelector('.modal-footer .btn-warning');
        if (po.status !== 'Billed') {
          saveBtn.disabled = true;
          saveBtn.innerHTML = '<i class="fas fa-lock"></i> Locked';
        } else {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i class="fas fa-edit"></i> Save / Edit Bill';
        }

        billModal.show();
      }

      // --- 4. SUBMIT EDIT ---
      function submitEdit() {
        const btn = document.querySelector('.modal-footer .btn-warning');
        const oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        btn.disabled = true;

        const payload = {
          id_po: currentEditingId,
          invoice_no: document.getElementById('modalInvNo').value,
          invoice_date: document.getElementById('modalInvDate').value,
          due_date: document.getElementById('modalDueDate').value,
          tax_mode: document.getElementById('modalTaxMode').value
        };

        fetch(APPS_SCRIPT_URL, {
          method: "POST",
          body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
          if(data.success) {
            alert("Data berhasil disimpan!");
            billModal.hide();
            fetchData(); // Refresh list
          } else {
            alert(data.message);
          }
          btn.innerHTML = oldText;
          btn.disabled = false;
        })
        .catch(err => {
          alert("Error saving data");
          btn.innerHTML = oldText;
          btn.disabled = false;
        });
      }

      // Search Logic
      document.getElementById('searchInput').addEventListener('keyup', function(e) {
        const keyword = e.target.value.toLowerCase();
        // Filter object GroupedData
        const filteredKeys = Object.keys(globalGroupedData).filter(key => {
          const po = globalGroupedData[key];
          return po.vendor.toLowerCase().includes(keyword) || 
                 po.id_po.toLowerCase().includes(keyword) ||
                 (po.invoice_no && po.invoice_no.toLowerCase().includes(keyword));
        });
        
        // Reconstruct temp object for render
        const filteredObj = {};
        filteredKeys.forEach(k => filteredObj[k] = globalGroupedData[k]);
        renderList(filteredObj);
      });

      // Utilities
      function parseNumber(v) { return v ? parseFloat(v.toString().replace(/,/g, '')) : 0; }
      function formatDateDisplay(d) { return (!d || d.includes('Invalid')) ? '-' : new Date(d).toLocaleDateString('id-ID'); }
      function parseDateForInput(d) {
        if(!d || d.includes('Invalid')) return '';
        const dt = new Date(d);
        return !isNaN(dt) ? dt.toISOString().split('T')[0] : '';
      }
      function formatCurrency(num) {
        return "Rp " + num.toLocaleString('id-ID', {minimumFractionDigits: 0});
      }
    </script>
</body>
</html>
