<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Item Dashboard</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.bootstrap5.min.css" rel="stylesheet">

    <style>
        body { background-color: #f4f6f9; font-size: 0.9rem; }
        /* Styling untuk Login */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; z-index: 9999; display: flex;
            justify-content: center; align-items: center;
        }
        .login-box { background: white; padding: 2rem; border-radius: 10px; width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .hidden { display: none !important; }
        
        /* Styling Tabel agar lebih padat seperti spreadsheet */
        #mainTable thead th {
            background-color: #e9ecef;
            vertical-align: middle;
            font-size: 0.85rem;
            font-weight: 700;
        }
        #mainTable tbody td {
            vertical-align: middle;
            padding: 0.5rem 0.5rem; /* Padding lebih kecil */
        }
        /* Styling untuk select filter di header */
        thead select {
            width: 100%;
            padding: 2px;
            font-size: 0.8rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin-top: 4px;
        }
        /* Warna status badge */
        .badge-active { background-color: #28a745; color: white; padding: 4px 8px; border-radius: 4px; }
        .badge-archived { background-color: #6c757d; color: white; padding: 4px 8px; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box text-center">
            <h3>üîê Master Data Login</h3>
            <p class="text-muted mb-4">Masukkan kredensial untuk akses.</p>
            <input type="password" id="passcode" class="form-control mb-3" placeholder="Kode Akses (misal: 123456)">
            <input type="text" id="username" class="form-control mb-3" placeholder="Nama Anda (Wajib untuk komentar)">
            <button onclick="checkLogin()" class="btn btn-primary w-100 fw-bold">MASUK DASHBOARD</button>
            <p id="error-msg" class="text-danger mt-3 hidden fw-bold"></p>
        </div>
    </div>

    <div class="container-fluid py-4 px-4 hidden" id="dashboard">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0 fw-bold text-primary">üì¶ Master Item Data List</h4>
            <div>
                User: <span id="displayUser" class="fw-bold text-success"></span>
                <button onclick="logout()" class="btn btn-sm btn-outline-danger ms-3">Logout</button>
            </div>
        </div>
        
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div id="loadingSpinner" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Sedang memuat data dari Spreadsheet...</p>
                </div>

                <table id="mainTable" class="table table-striped table-bordered table-hover w-100 hidden" style="width:100%">
                    <thead>
                        <tr>
                            <th>NAMA ITEM</th>
                            <th>VENDOR</th>
                            <th>SAT. BELI</th>
                            <th>SAT. JUAL</th>
                            <th class="text-end">HRG BELI</th>
                            <th class="text-end">HRG JUAL</th>
                            <th>Tipe Produk</th>
                            <th>Merk</th>
                            <th>Machine Used</th>
                            <th>Status</th>
                            <th class="text-center">Aksi</th>
                        </tr>
                        <tr id="filter-row">
                            <th></th><th></th><th></th><th></th><th></th><th></th>
                            <th></th> <th></th>
                            <th></th> <th></th> <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="commentModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title">üí¨ Kirim Catatan/Komentar</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Item:</label>
                        <input type="text" class="form-control fw-bold readonly-input" id="modalItemName" readonly>
                    </div>
                    <input type="hidden" id="modalItemCode"> <div class="mb-3">
                         <label class="form-label small">Isi Komentar:</label>
                        <textarea id="commentInput" class="form-control" rows="4" placeholder="Tulis catatan untuk item ini..."></textarea>
                    </div>
                </div>
                 <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" onclick="sendComment()" id="btnSendComment" class="btn btn-success">Kirim Komentar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>

    <script>
        // ================= KONFIGURASI UTAMA =================
        // GANTI URL INI DENGAN URL WEB APP ANDA YANG BARU DI-DEPLOY
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwPVZMblUpQiEvyO9buO0ZXW9iLpp709l7txNtD2PiTWeAGa7JVFAiX31_6NgdARnre/exec"; 
        
        const ACCESS_CODE = "123456"; // Ganti password sesuai keinginan
        let currentUser = "";
        let table; // Variabel global untuk DataTable

        // Helper: Format Rupiah
        const formatRupiah = (money) => {
             return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 2 }).format(money);
        }

        // ================= FUNGSI LOGIN =================
        function checkLogin() {
            const pass = document.getElementById('passcode').value;
            const user = document.getElementById('username').value.trim();
            const errorBox = document.getElementById('error-msg');
            
            if(pass === ACCESS_CODE && user !== "") {
                currentUser = user;
                localStorage.setItem("dashboardUser", currentUser); // Simpan sesi sederhana
                document.getElementById('displayUser').innerText = currentUser;
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                loadDataFromSheets(); // Mulai load data
            } else {
                errorBox.innerText = "Kode akses salah atau nama belum diisi!";
                errorBox.classList.remove('hidden');
            }
        }

        // Cek sesi login saat halaman direfresh (opsional)
        window.onload = function() {
            const savedUser = localStorage.getItem("dashboardUser");
            if(savedUser) {
                document.getElementById('username').value = savedUser;
                document.getElementById('passcode').focus();
            }
        }

        function logout() {
             localStorage.removeItem("dashboardUser");
             location.reload();
        }


        // ================= FUNGSI LOAD & RENDER DATA =================
        function loadDataFromSheets() {
            fetch(SCRIPT_URL + "?action=getProducts")
                .then(response => response.json())
                .then(data => {
                    // Data berhasil diload, sembunyikan spinner, tampilkan tabel
                    document.getElementById('loadingSpinner').classList.add('hidden');
                    document.getElementById('mainTable').classList.remove('hidden');
                    initializeDataTable(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loadingSpinner').innerHTML = '<p class="text-danger">Gagal memuat data. Pastikan URL Apps Script benar.</p>';
                });
        }

        function initializeDataTable(dataSet) {
            // MAPPING INDEX KOLOM SPREADSHEET (Dimulai dari 0 untuk Kolom A)
            // A=0, B=1, C=2, D=3, E=4(HrgBeli), F=5(HrgJual)
            // K=10(Tipe), L=11(Merk)
            // P=15(ItemCode/Unik), Q=16(Machine), R=17(Status)

            table = $('#mainTable').DataTable({
                data: dataSet,
                responsive: true,
                pageLength: 25, // Jumlah baris per halaman default
                order: [[0, 'asc']], // Default sort kolom pertama (Nama Item)
                // Definisi Kolom
                columns: [
                    { data: 0 }, // NAMA ITEM (Kolom A)
                    { data: 1 }, // VENDOR (Kolom B)
                    { data: 2 }, // SATUAN BELI (Kolom C)
                    { data: 3 }, // SATUAN JUAL (Kolom D)
                    { 
                        data: 4, // HRG BELI (Kolom E)
                        className: "text-end fw-bold",
                        render: function(data, type, row) { 
                            return (type === 'display' || type === 'filter') ? formatRupiah(data) : data; 
                        } 
                    },
                    { 
                        data: 5, // HRG JUAL (Kolom F)
                        className: "text-end fw-bold text-primary",
                        render: function(data, type, row) { 
                            return (type === 'display' || type === 'filter') ? formatRupiah(data) : data; 
                        }
                    },
                    { data: 10 }, // Tipe Produk (Kolom K) - Index 6 di tabel HTML
                    { data: 11 }, // Merk (Kolom L)
                    { data: 16 }, // Machine Used (Kolom Q) - Index 8 di tabel HTML
                    { 
                        data: 17, // Status (Kolom R) - Index 9 di tabel HTML
                        className: "text-center",
                        render: function(data) {
                            let statusStr = (data || "").toString(); // Pastikan string
                            if(statusStr.toLowerCase() === 'active') return '<span class="badge-active">Active</span>';
                            if(statusStr.toLowerCase().includes('archived')) return '<span class="badge-archived">Archived</span>';
                            return statusStr;
                        }
                    },
                    {
                        // Kolom Tombol Aksi (Tidak ada di spreadsheet)
                        data: null,
                        className: "text-center",
                        orderable: false,
                        render: function (data, type, row) {
                            // Menggunakan Kolom P (Index 15) sebagai ID Unik, dan Kolom A (Index 0) sebagai Nama
                            // Hati-hati dengan tanda kutip di dalam string
                            const safeItemName = row[0].replace(/'/g, "\\'").replace(/"/g, '&quot;');
                            const safeItemCode = row[15].replace(/'/g, "\\'"); 
                            return `<button class="btn btn-sm btn-warning shadow-sm px-3" onclick="openCommentModal('${safeItemCode}', '${safeItemName}')">üí¨ Komen</button>`;
                        }
                    }
                ],
                // FUNGSI UNTUK MEMBUAT DROPDOWN FILTER DI HEADER
                initComplete: function () {
                    this.api().columns([6, 8, 9]).every(function () { // Index kolom di HTML yg mau dikasih filter (Tipe=6, Machine=8, Status=9)
                        var column = this;
                        var select = $('<select class="form-select form-select-sm"><option value="">Semua</option></select>')
                            .appendTo( $('#filter-row').find('th').eq(column.index()) ) // Masukkan ke baris header kedua
                            .on('change', function () {
                                var val = $.fn.dataTable.util.escapeRegex($(this).val());
                                column.search(val ? '^' + val + '$' : '', true, false).draw();
                            });
                        
                        // Ambil data unik dari kolom tersebut untuk isi dropdown
                        column.data().unique().sort().each(function (d, j) {
                             // Bersihkan data jika kosong
                             let cleanData = d ? d.toString().trim() : "";
                             if(cleanData !== "") {
                                select.append('<option value="' + cleanData + '">' + cleanData + '</option>');
                             }
                        });
                    });
                }
            });
        }


        // ================= FUNGSI KOMENTAR =================
        // Menerima ItemCode (Kolom P) dan NamaItem (Kolom A)
        function openCommentModal(itemCode, itemName) {
            document.getElementById('modalItemName').value = itemName;
            document.getElementById('modalItemCode').value = itemCode;
            document.getElementById('commentInput').value = ""; // Reset textarea
            
            // Tampilkan Modal Bootstrap
            new bootstrap.Modal(document.getElementById('commentModal')).show();
        }

        function sendComment() {
            const comment = document.getElementById('commentInput').value;
            const itemCode = document.getElementById('modalItemCode').value;
            const itemName = document.getElementById('modalItemName').value;
            
            if(!comment.trim()) {
                alert("Komentar tidak boleh kosong!");
                return;
            }

            const btn = document.getElementById('btnSendComment');
            const originalText = btn.innerText;
            btn.innerText = "Mengirim...";
            btn.disabled = true;
            
            // Kirim ke Google Apps Script
            fetch(SCRIPT_URL, {
                method: "POST",
                // mode: "no-cors", // HAPUS baris ini jika ingin menerima respon JSON sukses/gagal
                body: JSON.stringify({
                    user: currentUser,
                    itemCode: itemCode, // Kirim ID Unik
                    itemName: itemName, // Kirim Nama Item juga
                    comment: comment
                })
            })
            .then(res => res.json()) // Mencoba parsing respon JSON
            .then(response => {
                if(response.result === "success") {
                    alert("Komentar berhasil disimpan di Sheet 'Comments'!");
                     // Tutup Modal
                    const modalEl = document.getElementById('commentModal');
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();
                } else {
                    alert("Gagal menyimpan: " + response.message);
                }
            })
            .catch(err => {
                 alert("Terjadi kesalahan jaringan atau script.");
                 console.error(err);
            })
            .finally(() => {
                btn.innerText = originalText;
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>
