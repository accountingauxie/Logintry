<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Item Dashboard</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f4f6f9; font-size: 0.9rem; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* LOGIN OVERLAY */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; z-index: 9999; display: flex;
            justify-content: center; align-items: center;
        }
        .login-box { background: white; padding: 2.5rem; border-radius: 12px; width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .hidden { display: none !important; }

        /* TABLE STYLING */
        .card-table { border-radius: 10px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        #mainTable thead th {
            background-color: #f8f9fa;
            color: #495057;
            vertical-align: middle;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        
        /* FILTER INPUTS IN HEADER */
        .filter-select {
            width: 100%; padding: 4px; font-size: 0.8rem; border: 1px solid #ced4da; border-radius: 4px; background-color: white;
        }

        /* BADGES */
        .badge-active { background-color: #d1e7dd; color: #0f5132; padding: 5px 10px; border-radius: 20px; font-weight: 600; font-size: 0.75rem;}
        .badge-archived { background-color: #e2e3e5; color: #41464b; padding: 5px 10px; border-radius: 20px; font-weight: 600; font-size: 0.75rem;}

        /* CHAT BUBBLES */
        .chat-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        .chat-item {
            background: white;
            border-left: 4px solid #0d6efd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .chat-meta { font-size: 0.75rem; color: #6c757d; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .chat-text { font-size: 0.9rem; color: #212529; margin: 0; white-space: pre-wrap; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box text-center">
            <h3 class="fw-bold mb-1">üîê Master Data</h3>
            <p class="text-muted small mb-4">Portal Internal - Silakan Login</p>
            
            <div class="form-floating mb-3">
                <input type="password" id="passcode" class="form-control" placeholder="Kode Akses">
                <label for="passcode">Kode Akses</label>
            </div>
            
            <div class="form-floating mb-3">
                <input type="text" id="username" class="form-control" placeholder="Nama Anda">
                <label for="username">Nama Anda (untuk komentar)</label>
            </div>

            <button onclick="checkLogin()" class="btn btn-primary w-100 py-2 fw-bold shadow-sm">MASUK DASHBOARD</button>
            <p id="error-msg" class="text-danger mt-3 hidden small fw-bold"></p>
        </div>
    </div>

    <div class="container-fluid py-4 px-4 hidden" id="dashboard">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="mb-0 fw-bold text-dark">üì¶ Master Item Data List</h4>
                <p class="text-muted small mb-0">List produk, harga, dan spesifikasi update real-time.</p>
            </div>
            <div class="bg-white px-3 py-2 rounded shadow-sm border">
                <small class="text-muted">User:</small> <span id="displayUser" class="fw-bold text-primary"></span>
                <span class="mx-2">|</span>
                <a href="#" onclick="logout()" class="text-danger small text-decoration-none fw-bold">Logout</a>
            </div>
        </div>
        
        <div class="card card-table">
            <div class="card-body">
                
                <div id="loadingSpinner" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3 text-muted small">Menghubungkan ke Google Sheets...</p>
                </div>

                <table id="mainTable" class="table table-hover w-100 hidden" style="width:100%">
                    <thead>
                        <tr>
                            <th>Nama Item</th>
                            <th>Vendor</th>
                            <th>Sat. Beli</th>
                            <th>Sat. Jual</th>
                            <th class="text-end">Hrg Beli</th>
                            <th class="text-end">Hrg Jual</th>
                            <th>Tipe</th>
                            <th>Merk</th>
                            <th>Machine</th>
                            <th class="text-center">Status</th>
                            <th class="text-center">Aksi</th>
                        </tr>
                        <tr id="filter-row">
                            <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="commentModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <div>
                        <h5 class="modal-title fw-bold" id="modalTitle">Detail Item</h5>
                        <small class="text-muted" id="modalSubtitle">ID: -</small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body row">
                    <div class="col-md-12 mb-3">
                        <div class="alert alert-info border-0 d-flex align-items-center" role="alert">
                            <div>Sedang melihat komentar untuk: <strong><span id="displayItemName"></span></strong></div>
                        </div>
                    </div>
                    
                    <input type="hidden" id="modalItemCode">
                    <input type="hidden" id="modalItemNameHidden">

                    <div class="col-12 mb-3">
                        <label class="form-label fw-bold small text-uppercase text-muted">Riwayat Diskusi</label>
                        <div id="commentHistory" class="chat-box">
                            <p class="text-center text-muted my-2"><i>Memuat data...</i></p>
                        </div>
                    </div>

                    <div class="col-12">
                        <label class="form-label fw-bold small text-uppercase text-muted">Tulis Pesan Baru</label>
                        <div class="input-group">
                            <textarea id="commentInput" class="form-control" rows="2" placeholder="Ketetik catatan atau pertanyaan di sini..."></textarea>
                            <button class="btn btn-primary px-4" type="button" onclick="sendComment()" id="btnSend">
                                <i class="bi bi-send"></i> Kirim
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
        // ==========================================
        // KONFIGURASI (WAJIB DIISI)
        // ==========================================
        // GANTI URL DI BAWAH INI DENGAN URL WEB APP DEPLOYMENT ANDA
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw3K81o9k3ik-HpA_j8G3tJl7fIC90OFDc8o7tS4vMxhkf1kP9MJy38hxoXGDUNhXyi/exec"; 
        
        const ACCESS_CODE = "123456"; // Password Masuk
        
        // ==========================================
        // LOGIC APLIKASI
        // ==========================================
        let currentUser = "";
        let table;

        // 1. SYSTEM LOGIN
        function checkLogin() {
            const pass = document.getElementById('passcode').value;
            const user = document.getElementById('username').value.trim();
            const errorBox = document.getElementById('error-msg');
            
            if(pass === ACCESS_CODE && user !== "") {
                currentUser = user;
                localStorage.setItem("dashboardUser", currentUser); // Simpan sesi
                initDashboard();
            } else {
                errorBox.innerText = "Password salah atau Nama kosong!";
                errorBox.classList.remove('hidden');
            }
        }

        function initDashboard() {
            document.getElementById('displayUser').innerText = currentUser;
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            loadDataFromSheets();
        }

        function logout() {
            localStorage.removeItem("dashboardUser");
            location.reload();
        }

        // Auto Login jika sudah pernah login sebelumnya
        window.onload = function() {
            const savedUser = localStorage.getItem("dashboardUser");
            if(savedUser) {
                currentUser = savedUser;
                initDashboard();
            }
        }

        // 2. HELPER: FORMAT RUPIAH
        const formatRupiah = (num) => {
             return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
        }

        // 3. LOAD DATA UTAMA (PRODUCT LIST)
        function loadDataFromSheets() {
            fetch(SCRIPT_URL + "?action=getProducts")
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loadingSpinner').classList.add('hidden');
                    document.getElementById('mainTable').classList.remove('hidden');
                    initializeDataTable(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loadingSpinner').innerHTML = 
                        '<div class="alert alert-danger">Gagal mengambil data. Cek URL Script / Koneksi Internet.</div>';
                });
        }

        // 4. SETUP DATATABLES
        function initializeDataTable(dataSet) {
            // Mapping Index Spreadsheet (Sesuaikan jika kolom geser)
            // Asumsi: A=0, B=1, ... K=10, L=11, P=15, Q=16, R=17
            
            table = $('#mainTable').DataTable({
                data: dataSet,
                responsive: true,
                pageLength: 25,
                language: { search: "Cari Barang:", lengthMenu: "Tampil _MENU_ item", info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ item" },
                columns: [
                    { data: 0, className: "fw-bold" }, // Nama
                    { data: 1 }, // Vendor
                    { data: 2 }, // Sat Beli
                    { data: 3 }, // Sat Jual
                    { data: 4, className: "text-end", render: (d) => formatRupiah(d) }, // Hrg Beli
                    { data: 5, className: "text-end text-success fw-bold", render: (d) => formatRupiah(d) }, // Hrg Jual
                    { data: 10 }, // Tipe (Kolom K)
                    { data: 11 }, // Merk (Kolom L)
                    { data: 16 }, // Machine (Kolom Q)
                    { 
                        data: 17, // Status (Kolom R)
                        className: "text-center",
                        render: function(data) {
                            let s = (data || "").toString().toLowerCase();
                            if(s.includes('active')) return `<span class="badge-active">Active</span>`;
                            if(s.includes('archived')) return `<span class="badge-archived">Archived</span>`;
                            return s;
                        }
                    },
                    {
                        // Tombol Aksi
                        data: null,
                        className: "text-center",
                        orderable: false,
                        render: function (data, type, row) {
                            // Escape tanda kutip biar gak error
                            const safeName = row[0].replace(/["']/g, ""); 
                            const safeCode = row[15]; // Ambil ItemCode (Kolom P)
                            
                            return `<button class="btn btn-sm btn-outline-primary shadow-sm" onclick="openCommentModal('${safeCode}', '${safeName}')">
                                    üí¨ Chat
                                    </button>`;
                        }
                    }
                ],
                initComplete: function () {
                    // Membuat Dropdown Filter Otomatis untuk Kolom Tipe(6), Machine(8), Status(9)
                    this.api().columns([6, 8, 9]).every(function () {
                        var column = this;
                        var select = $('<select class="filter-select"><option value="">Semua</option></select>')
                            .appendTo( $('#filter-row').find('th').eq(column.index()) )
                            .on('change', function () {
                                var val = $.fn.dataTable.util.escapeRegex($(this).val());
                                column.search(val ? '^' + val + '$' : '', true, false).draw();
                            });
                        
                        column.data().unique().sort().each(function (d, j) {
                            if(d) select.append('<option value="' + d + '">' + d + '</option>');
                        });
                    });
                }
            });
        }

        // 5. FITUR KOMENTAR (BACA & TULIS)
        function openCommentModal(itemCode, itemName) {
            // Set Modal Info
            document.getElementById('displayItemName').innerText = itemName;
            document.getElementById('modalSubtitle').innerText = "Item Code: " + itemCode;
            document.getElementById('modalItemCode').value = itemCode;
            document.getElementById('modalItemNameHidden').value = itemName;
            document.getElementById('commentInput').value = ""; // Reset input
            
            // Show Modal
            new bootstrap.Modal(document.getElementById('commentModal')).show();
            
            // Load History
            loadComments(itemCode);
        }

        function loadComments(targetItemCode) {
            const historyBox = document.getElementById('commentHistory');
            historyBox.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';

            fetch(SCRIPT_URL + "?action=getComments")
                .then(res => res.json())
                .then(data => {
                    historyBox.innerHTML = ""; 
                    // Filter berdasarkan ItemCode (Index 2 di sheet Comments)
                    const filtered = data.filter(row => row[2] == targetItemCode);
                    
                    if (filtered.length === 0) {
                        historyBox.innerHTML = '<p class="text-center text-muted small my-4">Belum ada diskusi untuk item ini.</p>';
                    } else {
                        // Loop data dan render bubble chat
                        filtered.forEach(row => {
                            // Row structure: 0=Time, 1=User, 2=Code, 3=Name, 4=Comment
                            const dateRaw = new Date(row[0]);
                            const dateStr = dateRaw.toLocaleDateString('id-ID') + ' ' + dateRaw.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
                            
                            const bubble = `
                                <div class="chat-item">
                                    <div class="chat-meta">
                                        <strong>${row[1]}</strong>
                                        <span>${dateStr}</span>
                                    </div>
                                    <p class="chat-text">${row[4]}</p>
                                </div>
                            `;
                            historyBox.innerHTML += bubble;
                        });
                        // Auto scroll ke bawah
                        historyBox.scrollTop = historyBox.scrollHeight;
                    }
                })
                .catch(err => {
                    historyBox.innerHTML = '<p class="text-danger text-center small">Gagal memuat history.</p>';
                });
        }

        function sendComment() {
            const txt = document.getElementById('commentInput').value;
            const code = document.getElementById('modalItemCode').value;
            const name = document.getElementById('modalItemNameHidden').value;
            const btn = document.getElementById('btnSend');

            if(!txt.trim()) return alert("Pesan tidak boleh kosong");

            // Loading state button
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = "Mengirim...";
            btn.disabled = true;

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    user: currentUser,
                    itemCode: code,
                    itemName: name,
                    comment: txt
                })
            })
            .then(res => res.json())
            .then(resp => {
                if(resp.result === "success") {
                    document.getElementById('commentInput').value = ""; // Clear
                    loadComments(code); // Refresh history otomatis
                } else {
                    alert("Error: " + resp.message);
                }
            })
            .catch(err => alert("Gagal mengirim pesan"))
            .finally(() => {
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>
