<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Item List - Auxilium</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    
    <style>
        /* =========================================
           1. SYSTEM STYLE 
           ========================================= */
        :root { 
            --primary-color: #116999; 
            --primary-hover: #0e5a85;
            --bg-body: #f8fafc;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --success-bg: #dcfce7; --success-text: #166534;
            --border-color: #eaecf0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        body { 
            margin: 0; font-family: "Inter", sans-serif; font-size: 13.5px; 
            background: var(--bg-body); color: var(--text-main); 
        }

        .hidden { display: none !important; }

        /* --- NAVBAR --- */
        .aux-navbar {
            background-color: #ffffff; height: 70px; display: flex; align-items: center;
            justify-content: space-between; padding: 0 40px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); position: sticky; top: 0; z-index: 1000;
        }
        .aux-logo img { height: 45px; width: auto; }
        .aux-menu { display: flex; gap: 8px; align-items: center; height: 100%; }
        .aux-link { 
            text-decoration: none; color: #475467; font-weight: 600; font-size: 14px; 
            padding: 8px 16px; border-radius: 6px; transition: all 0.2s; cursor: pointer; display: flex; gap: 6px;
        }
        .aux-link:hover { background-color: #f2f4f7; color: #101828; }
        .aux-link.active { background-color: #eff8ff; color: var(--primary-color); font-weight: 700; }
        
        /* Dropdown Menu */
        .nav-item { position: relative; height: 100%; display: flex; align-items: center; }
        .dropdown-menu-aux {
            visibility: hidden; opacity: 0; position: absolute; top: 85%; left: 0; 
            background: white; min-width: 240px; border: 1px solid var(--border-color); 
            border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); padding: 8px; 
            z-index: 9999; transform: translateY(10px); transition: all 0.2s; display: block;
        }
        .nav-item:hover .dropdown-menu-aux { visibility: visible; opacity: 1; transform: translateY(0); }
        .dropdown-item-aux { display: flex; padding: 10px 12px; color: #344054; text-decoration: none; border-radius: 6px; }
        .dropdown-item-aux:hover { background: #f9fafb; color: var(--primary-color); }
        .dropdown-header-aux { font-size: 11px; font-weight: 600; color: #98a2b3; padding: 8px 12px 4px; text-transform: uppercase; }

        /* User Panel */
        .user-panel { display: flex; align-items: center; gap: 12px; padding-left: 20px; border-left: 1px solid var(--border-color); }
        .user-avatar { width: 36px; height: 36px; background: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .logout-btn { background: none; border: 1px solid var(--border-color); width: 36px; height: 36px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .logout-btn:hover { background: #fee2e2; color: #991b1b; border-color: #fee2e2; }

        /* --- DASHBOARD --- */
        .main-container { max-width: 1600px; margin: 0 auto; padding: 30px 40px; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; border-radius: 12px; padding: 20px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); }
        .kpi-value { font-size: 28px; font-weight: 700; color: var(--text-main); }
        .kpi-label { font-size: 12px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; margin-bottom: 8px; }

        /* --- TABLE --- */
        .card-table-wrapper { background: white; border-radius: 16px; border: 1px solid var(--border-color); box-shadow: var(--shadow-sm); overflow: visible; }
        .table-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: white; border-top-left-radius: 16px; border-top-right-radius: 16px; position: relative; z-index: 10; }
        
        table.dataTable thead th { background: #f8fafc !important; color: #475467; font-size: 11px; text-transform: uppercase; padding: 14px 16px; border-bottom: 1px solid var(--border-color) !important; }
        table.dataTable tbody td { padding: 12px 16px; font-size: 13px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        
        .badge-dss { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .badge-active { background: var(--success-bg); color: var(--success-text); border: 1px solid #bbf7d0; }
        .badge-archived { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
        .btn-icon-soft { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color); background: white; color: #64748b; transition: all 0.2s; }
        .btn-icon-soft:hover { background: #f8fafc; color: var(--primary-color); border-color: #b9e6fe; }
        .editable-price { cursor: pointer; color: var(--primary-color); font-weight: 600; padding: 4px 8px; border-radius: 6px; }
        .editable-price:hover { background: #f0f9ff; }

        /* --- FILTER STYLES (MULTI-SELECT) --- */
        .btn-filter-toggle { height: 42px; display: flex; align-items: center; gap: 8px; background: #fff; border: 1px solid var(--border-color); color: #475467; font-weight: 600; font-size: 13px; padding: 0 16px; border-radius: 8px; cursor: pointer; }
        .btn-filter-toggle.active { background: #eff8ff; border-color: var(--primary-color); color: var(--primary-color); }
        
        .filter-popup { position: absolute; right: 0; top: 115%; width: 600px; background: white; border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 12px 16px -4px rgba(16, 24, 40, 0.08); z-index: 50; display: none; padding: 16px; }
        .filter-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: flex-start; background: #f9fafb; padding: 10px; border-radius: 8px; border: 1px solid #f2f4f7; }
        .filter-select { padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px; outline: none; background: white; height: 38px; }
        .filter-input { padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px; outline: none; flex: 1; height: 38px; }

        /* Multi-Select Custom Checkbox Style */
        .ms-wrapper { position: relative; width: 100%; }
        .ms-trigger { 
            background: white; border: 1px solid var(--border-color); border-radius: 6px; 
            padding: 8px 12px; font-size: 13px; cursor: pointer; display: flex; 
            justify-content: space-between; align-items: center; min-height: 38px;
        }
        .ms-trigger:hover { background: #fcfcfd; border-color: #d0d5dd; }
        .ms-dropdown {
            position: absolute; top: 105%; left: 0; width: 100%; 
            background: white; border: 1px solid var(--border-color); border-radius: 8px;
            box-shadow: 0 4px 6px -2px rgba(0,0,0,0.05); max-height: 200px; overflow-y: auto;
            z-index: 100; display: none; padding: 5px;
        }
        .ms-option { display: flex; align-items: center; padding: 6px 8px; cursor: pointer; font-size: 13px; border-radius: 4px; }
        .ms-option:hover { background-color: #f2f4f7; }
        .ms-option input { margin-right: 8px; width: 14px; height: 14px; cursor: pointer; }
        .ms-count { background: #e0f2fe; color: #0284c7; padding: 2px 6px; border-radius: 10px; font-size: 11px; font-weight: 600; margin-left: auto; }

        /* Login Overlay */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); border: 1px solid var(--border-color); }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box text-center">
            <img src="https://raw.githubusercontent.com/accountingauxie/Auxilium-Portal-Sukses-Jaya/refs/heads/main/assets/auxilium_logo.png" alt="Logo" style="height: 45px; margin-bottom: 24px;">
            <h4 style="font-weight: 700; color: #101828; margin-bottom: 8px;">Log in</h4>
            <div class="form-floating mb-3 text-start">
                <input type="email" id="email" class="form-control" placeholder="Email">
                <label>Email User</label>
            </div>
            <div class="form-floating mb-3 text-start">
                <input type="password" id="password" class="form-control" placeholder="Password">
                <label>Password</label>
            </div>
            <button onclick="performLogin()" id="btnLogin" class="btn btn-primary w-100 fw-bold" style="background:var(--primary-color);">Masuk</button>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        
        <div class="aux-navbar">
            <div class="aux-logo">
                <img src="https://raw.githubusercontent.com/accountingauxie/Auxilium-Portal-Sukses-Jaya/refs/heads/main/assets/auxilium_logo_pure_white_bg.png" alt="Auxilium Logo">
            </div>
            
            <nav class="aux-menu">
                <div class="nav-item"><a href="#" class="aux-link">Home</a></div>
                <div class="nav-item">
                    <div class="aux-link active">Persediaan <i data-feather="chevron-down" style="width:14px;"></i></div>
                    <div class="dropdown-menu-aux">
                        <div class="dropdown-header-aux">Inventory</div>
                        <a href="#" class="dropdown-item-aux fw-bold" style="color:var(--primary-color);">Master Item List</a>
                    </div>
                </div>
            </nav>

            <div class="user-panel">
                <div style="text-align:right; line-height:1.3;">
                    <span class="d-block fw-bold" style="font-size:13px;" id="display-nama">User</span>
                    <span class="d-block text-muted" style="font-size:11px;" id="display-role">Staff</span>
                </div>
                <div class="user-avatar" id="display-initial">U</div>
                <button class="logout-btn" onclick="showLogoutModal()"><i data-feather="log-out" style="width:16px;"></i></button>
            </div>
        </div>

        <div class="main-container">
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">Total Item SKU</div>
                    <div class="kpi-value" id="kpi-total">0</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Status Active</div>
                    <div class="kpi-value" id="kpi-active">0</div>
                </div>
            </div>

            <div class="card-table-wrapper">
                <div class="table-header">
                    <div class="table-title">
                        <h3>Inventory Database</h3>
                        <p>Kelola harga beli, harga jual, dan status ketersediaan item.</p>
                    </div>
                    
                    <div class="d-flex gap-2 position-relative">
                        <div class="position-relative">
                            <button id="btnFilterToggle" class="btn-filter-toggle" onclick="toggleFilterPopup()">
                                <i class="bi bi-funnel"></i> Filter
                            </button>

                            <div id="filterPopup" class="filter-popup">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="m-0 fw-bold">Filter Conditions</h6>
                                    <button class="btn btn-sm text-primary fw-bold" onclick="addFilterRow()">+ Add Condition</button>
                                </div>
                                <div id="filterRowsContainer"></div>
                                <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
                                    <button class="btn btn-sm btn-light border" onclick="clearFilters()">Reset</button>
                                    <button class="btn btn-sm btn-primary" onclick="applyFilters()">Apply Filter</button>
                                </div>
                            </div>
                        </div>

                        <div style="position:relative; width:300px;">
                            <i class="bi bi-search" style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#94a3b8;"></i>
                            <input type="text" id="customSearch" class="form-control" style="padding-left:36px; font-size:13px;" placeholder="Cari Item, Vendor, atau Kode...">
                        </div>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div id="skeletonLoader" class="p-4">
                        <div class="d-flex gap-3 mb-3"><div class="skeleton" style="width:30%"></div><div class="skeleton" style="width:20%"></div></div>
                        <div class="skeleton mb-2"></div><div class="skeleton mb-2"></div>
                    </div>

                    <div class="table-responsive">
                        <table id="mainTable" class="table w-100 hidden">
                            <thead>
                                <tr>
                                    <th>Nama Item</th>
                                    <th>Vendor</th>
                                    <th>Sat. Beli</th>
                                    <th>Sat. Jual</th>
                                    <th class="text-end">Hrg Beli</th>
                                    <th class="text-end">Hrg Jual</th>
                                    <th>Tipe</th>
                                    <th>Merk</th>
                                    <th>Machine</th>
                                    <th class="text-center">Status</th>
                                    <th class="text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="logoutModal" class="modal-logout" style="display:none; position:fixed; z-index:20000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); backdrop-filter:blur(4px);">
        <div class="modal-logout-content" style="background:#fff; margin:15% auto; padding:32px; border-radius:16px; width:360px; text-align:center;">
             <p style="font-weight:bold;">Konfirmasi Keluar?</p>
             <div class="d-flex justify-content-center gap-2 mt-3">
                 <button class="btn btn-light" onclick="closeLogoutModal()">Batal</button>
                 <button class="btn btn-danger" onclick="confirmLogout()">Keluar</button>
             </div>
        </div>
    </div>

    <div class="modal fade" id="priceModal" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title fw-bold">Update Harga Jual</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small mb-1 text-muted" id="editPriceItemName"></p>
                    <input type="number" id="inputNewPrice" class="form-control fw-bold text-end mb-3" style="font-size:16px; color:#116999;">
                    <input type="hidden" id="editPriceItemCode">
                    <input type="hidden" id="editPriceOldValue"> 
                    <button onclick="submitPriceUpdate()" id="btnSavePrice" class="btn btn-primary w-100">Simpan Perubahan</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="commentModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title fw-bold">Riwayat & Diskusi Item</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalItemCode"><input type="hidden" id="modalItemNameHidden">
                    <div id="commentHistory" class="chat-box mb-3"></div>
                    <div id="commentInputArea" class="input-group">
                        <textarea id="commentInput" class="form-control" rows="2" placeholder="Tulis catatan atau revisi..." style="font-size:13px;"></textarea>
                        <button class="btn btn-primary" onclick="sendComment()" id="btnSend">Kirim</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    
    <script>
        // === CONFIG & AUTH ===
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzPV35i00thIZJgwSEqo54IYzOjOvgwmeoW4gf77hL3SnL9-_eZ4cIldx1Zgt2XJgnc/exec"; 
        let currentUser = "";
        let perms = { 
            editPrice: false, addComment: false, editStatus: false, 
            addNewItem: false, viewPrice: false 
        };
        let table;

        function performLogin() {
            const email = $('#email').val(), pass = $('#password').val();
            if(!email || !pass) return Swal.fire('Error','Isi semua data','error');
            $('#btnLogin').text("Loading...").prop('disabled',true);

            fetch(SCRIPT_URL, {
                method: "POST", body: JSON.stringify({ action: "login", email: email, password: pass })
            }).then(r=>r.json()).then(resp => {
                if(resp.result === "success") {
                    currentUser = resp.username;
                    perms.editPrice = (String(resp.permissions.editPrice).toUpperCase() === "TRUE");
                    perms.addComment = (String(resp.permissions.addComment).toUpperCase() === "TRUE");
                    perms.editStatus = (String(resp.permissions.editStatus).toUpperCase() === "TRUE");
                    perms.addNewItem = (String(resp.permissions.addNewItem).toUpperCase() === "TRUE");
                    perms.viewPrice = (String(resp.permissions.viewPrice).toUpperCase() === "TRUE");
                    localStorage.setItem("appSession", JSON.stringify({ user: currentUser, permissions: perms }));
                    initDashboard();
                } else { Swal.fire('Gagal', 'Login failed', 'error'); }
            }).finally(()=> $('#btnLogin').text("Masuk").prop('disabled',false));
        }

        function initDashboard() {
            $('#login-overlay').addClass('hidden');
            $('#dashboard').removeClass('hidden');
            const name = currentUser.split('@')[0];
            $('#display-nama').text(name.charAt(0).toUpperCase() + name.slice(1));
            $('#display-role').text(perms.editPrice ? "Admin" : "Staff");
            feather.replace();
            loadData();
        }

        window.onload = function() {
            const sess = localStorage.getItem("appSession");
            if(sess) {
                const data = JSON.parse(sess);
                currentUser = data.user; perms = data.permissions;
                initDashboard();
            }
        }
        function showLogoutModal(){ $('#logoutModal').show(); }
        function closeLogoutModal(){ $('#logoutModal').hide(); }
        function confirmLogout(){ localStorage.removeItem("appSession"); location.reload(); }

        // === TABLE & DATA ===
        const formatRp = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);

        function loadData() {
            if ($.fn.DataTable.isDataTable('#mainTable')) return;
            fetch(SCRIPT_URL + "?action=getProducts").then(r=>r.json()).then(data => {
                $('#kpi-total').text(data.length);
                $('#kpi-active').text(data.filter(r=>(r[17]||"").toLowerCase().includes("active")).length);
                $('#skeletonLoader').addClass('hidden');
                $('#mainTable').removeClass('hidden');
                
                table = $('#mainTable').DataTable({
                    data: data, pageLength: 20, responsive: true,
                    dom: 't<"d-flex justify-content-between pt-3"ip>',
                    columns: [
                        { data: 0, className: "fw-bold text-dark", width: "20%" },
                        { data: 1 }, { data: 2 }, { data: 3 },
                        { data: 4, className: "text-end", render: d => perms.viewPrice ? formatRp(d) : "*****" },
                        { data: 5, className: "text-end", render: function(data, type, row) {
                            if(!perms.viewPrice) return '<span class="text-muted">*****</span>';
                            const txt = formatRp(data);
                            if(perms.editPrice) {
                                const safeName = row[0].replace(/["']/g, ""); 
                                const safeCode = row[15]; 
                                return `<div class="editable-price" onclick="openPriceModal('${safeCode}','${safeName}',${data})">${txt} <i class="bi bi-pencil-fill ms-1" style="font-size:9px; opacity:0.5;"></i></div>`;
                            }
                            return `<span class="fw-bold text-dark">${txt}</span>`;
                        }},
                        { data: 10 }, { data: 11 }, { data: 16 },
                        { data: 17, className: "text-center", render: function(d, type, row) {
                             const s = (d||"").toString();
                             const cls = s.toLowerCase().includes('active') ? 'badge-active' : 'badge-archived';
                             const icon = s.toLowerCase().includes('active') ? '<i class="bi bi-check-circle-fill text-success me-1"></i>' : '<i class="bi bi-archive-fill text-secondary me-1"></i>';
                             
                             if(perms.editStatus) {
                                const newStatus = s.toLowerCase() === 'active' ? 'Archived' : 'Active';
                                return `<div onclick="quickStatusUpdate('${row[15]}', '${newStatus}', '${s}')" style="cursor:pointer;" class="badge-dss ${cls}">${icon} ${s}</div>`;
                             }
                             return `<span class="badge-dss ${cls}">${icon} ${s}</span>`;
                        }},
                        { data: null, className: "text-center", render: function(d,t,r) {
                             return `<button class="btn-icon-soft" onclick="openCommentModal('${r[15]}', '${r[0].replace(/["']/g, "")}')"><i class="bi bi-chat-text"></i></button>`;
                        }} 
                    ]
                });
                $('#customSearch').on('keyup', function() { table.search(this.value).draw(); });
            });
        }

        // === MULTI-SELECT FILTER LOGIC ===
        const filterConfig = [
            { label: 'Vendor', idx: 1, type: 'multiselect' },
            { label: 'Satuan Beli', idx: 2, type: 'multiselect' },
            { label: 'Satuan Jual', idx: 3, type: 'multiselect' },
            { label: 'Harga Jual', idx: 5, type: 'number' },
            { label: 'Tipe', idx: 6, type: 'multiselect' },
            { label: 'Merk', idx: 7, type: 'multiselect' },
            { label: 'Status', idx: 9, type: 'multiselect' }
        ];

        function toggleFilterPopup() {
            const popup = $('#filterPopup');
            if(popup.is(':visible')) { popup.hide(); $('#btnFilterToggle').removeClass('active'); }
            else { 
                popup.show(); 
                if($('#filterRowsContainer').children().length === 0) addFilterRow();
                $('#btnFilterToggle').addClass('active');
            }
        }

        function getUniqueValues(colIdx) {
            return table.column(colIdx).data().unique().sort().toArray().map(d => {
                if(typeof d === 'string' && d.includes('<')) return d.replace(/<[^>]*>?/gm, '').trim();
                return d;
            }).filter(v => v !== "");
        }

        function addFilterRow() {
            const container = $('#filterRowsContainer');
            const rowId = 'row-' + Date.now();
            
            let colOptions = filterConfig.map(c => `<option value="${c.idx}" data-type="${c.type}">${c.label}</option>`).join('');
            
            const html = `
                <div class="filter-row" id="${rowId}">
                    <select class="filter-select col-selector" style="width:140px;" onchange="renderInputControl('${rowId}')">
                        ${colOptions}
                    </select>
                    <div class="control-container flex-grow-1" id="${rowId}-control"></div>
                    <button class="btn-remove-row" onclick="$(this).closest('.filter-row').remove()"><i class="bi bi-x-lg"></i></button>
                </div>
            `;
            container.append(html);
            renderInputControl(rowId);
        }

        function renderInputControl(rowId) {
            const row = $('#' + rowId);
            const colSelect = row.find('.col-selector');
            const container = row.find('.control-container');
            const type = colSelect.find(':selected').data('type');
            const colIdx = colSelect.val();

            let html = '';

            if (type === 'multiselect') {
                const values = getUniqueValues(colIdx);
                let checkList = values.map(v => `
                    <label class="ms-option">
                        <input type="checkbox" value="${v}" onchange="updateMultiSelectText('${rowId}')"> ${v}
                    </label>
                `).join('');

                html = `
                    <div class="ms-wrapper">
                        <div class="ms-trigger" onclick="toggleMsDropdown('${rowId}')">
                            <span class="ms-text text-muted">Select Items...</span>
                            <i class="bi bi-chevron-down small"></i>
                        </div>
                        <div class="ms-dropdown" id="${rowId}-dropdown">
                            ${checkList}
                        </div>
                    </div>
                `;
            } 
            else if (type === 'number') {
                html = `
                    <div class="d-flex gap-2">
                        <select class="filter-select op-selector" style="width:100px;">
                            <option value="gt"> > </option><option value="lt"> < </option><option value="eq"> = </option>
                        </select>
                        <input type="number" class="filter-input val-input" placeholder="Rp Value">
                    </div>
                `;
            }
            container.html(html);
        }

        window.toggleMsDropdown = function(rowId) {
            const dropdown = $('#' + rowId + '-dropdown');
            $('.ms-dropdown').not(dropdown).hide(); // Close others
            dropdown.toggle();
        }

        window.updateMultiSelectText = function(rowId) {
            const row = $('#' + rowId);
            const checked = row.find('input[type="checkbox"]:checked');
            const triggerText = row.find('.ms-text');
            
            if(checked.length === 0) {
                triggerText.text("Select Items...");
                triggerText.addClass("text-muted");
            } else {
                triggerText.text(`${checked.length} Selected`);
                triggerText.removeClass("text-muted");
                if(row.find('.ms-trigger .ms-count').length === 0) {
                     row.find('.ms-trigger').append(`<span class="ms-count">${checked.length}</span>`);
                } else {
                     row.find('.ms-count').text(checked.length);
                }
            }
        }

        $(document).on('click', function(e) {
            if (!$(e.target).closest('.ms-wrapper').length) {
                $('.ms-dropdown').hide();
            }
        });

        function clearFilters() {
            $('#filterRowsContainer').empty();
            addFilterRow();
            applyFilters();
        }

        function applyFilters() {
            table.draw();
            $('#filterPopup').hide();
            
            let hasFilters = false;
            $('.val-input').each(function(){ if($(this).val()) hasFilters=true; });
            $('input[type="checkbox"]:checked').each(function(){ hasFilters=true; });
            
            if(hasFilters) {
                $('#btnFilterToggle').addClass('active').html('<i class="bi bi-funnel-fill"></i> Active');
            } else {
                $('#btnFilterToggle').removeClass('active').html('<i class="bi bi-funnel"></i> Filter');
            }
        }

        // === CORE SEARCH LOGIC ===
        $.fn.dataTable.ext.search.push(
            function(settings, data, dataIndex) {
                const rows = document.querySelectorAll('.filter-row');
                if (rows.length === 0) return true;

                let allMatch = true;

                rows.forEach(row => {
                    const $row = $(row);
                    const colIdx = $row.find('.col-selector').val();
                    const type = $row.find('.col-selector :selected').data('type');
                    
                    let cellData = data[colIdx].toLowerCase().replace(/<[^>]*>?/gm, '').trim();

                    if (type === 'multiselect') {
                        const checked = $row.find('input[type="checkbox"]:checked').map(function(){
                            return this.value.toLowerCase();
                        }).get();

                        if (checked.length > 0) {
                            // Logic OR inside category (e.g. Vendor A OR Vendor B)
                            if (!checked.includes(cellData)) allMatch = false;
                        }
                    } 
                    else if (type === 'number') {
                        const op = $row.find('.op-selector').val();
                        const val = parseFloat($row.find('.val-input').val());
                        let cellNum = parseFloat(data[colIdx].replace(/[^0-9]/g, '')) || 0;

                        if (!isNaN(val)) {
                            if (op === 'gt' && cellNum <= val) allMatch = false;
                            if (op === 'lt' && cellNum >= val) allMatch = false;
                            if (op === 'eq' && cellNum !== val) allMatch = false;
                        }
                    }
                });

                return allMatch;
            }
        );

        // === EDIT & FUNCTIONS ===
        function openPriceModal(code, name, price) {
            $('#editPriceItemName').text(name);
            $('#editPriceItemCode').val(code);
            $('#inputNewPrice').val(price);
            $('#editPriceOldValue').val(price);
            new bootstrap.Modal(document.getElementById('priceModal')).show();
        }

        function submitPriceUpdate() {
            const code = $('#editPriceItemCode').val();
            const newVal = $('#inputNewPrice').val();
            const oldVal = $('#editPriceOldValue').val();
            const btn = $('#btnSavePrice');
            
            btn.text("Menyimpan...").prop('disabled',true);
            fetch(SCRIPT_URL, {
                method: "POST", 
                body: JSON.stringify({ action: "updatePrice", user: currentUser, itemCode: code, newValue: newVal, oldValue: oldVal })
            }).then(r=>r.json()).then(res => {
                if(res.result=="success") { 
                    Swal.fire('Berhasil', 'Harga telah diperbarui.', 'success').then(() => location.reload()); 
                } else { 
                    Swal.fire('Gagal', res.message, 'error'); 
                    btn.prop('disabled',false).text("Simpan Perubahan"); 
                }
            });
        }

        function quickStatusUpdate(code, newStatus, oldStatus) {
            Swal.fire({
                title: `Ubah status ke ${newStatus}?`, icon: 'question',
                showCancelButton: true, confirmButtonColor: '#116999',
                confirmButtonText: 'Ya, Ubah', cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.showLoading();
                    fetch(SCRIPT_URL, {
                        method: "POST", 
                        body: JSON.stringify({ action: "updateStatus", user: currentUser, itemCode: code, newValue: newStatus, oldValue: oldStatus })
                    }).then(r=>r.json()).then(res => {
                        if(res.result=="success") { location.reload(); }
                        else { Swal.fire('Gagal', 'Terjadi kesalahan.', 'error'); }
                    });
                }
            });
        }

        function openCommentModal(code, name) {
            $('#modalItemCode').val(code);
            $('#modalItemNameHidden').val(name);
            new bootstrap.Modal(document.getElementById('commentModal')).show();
            if(perms.addComment) $('#commentInputArea').removeClass('hidden');
            else $('#commentInputArea').addClass('hidden');
            loadComments(code);
        }

        function loadComments(code) {
            const box = $('#commentHistory');
            box.html("<div class='text-center py-3'><div class='spinner-border spinner-border-sm text-primary'></div></div>");
            fetch(SCRIPT_URL + "?action=getComments").then(r=>r.json()).then(data => {
                box.empty();
                const chats = data.filter(r => r[2] == code);
                if(chats.length === 0) box.html("<div class='text-center py-4 text-muted small'>Belum ada catatan.</div>");
                chats.forEach(c => {
                   const date = new Date(c[0]).toLocaleString('id-ID');
                   box.append(`<div class="mb-2"><div class="d-flex justify-content-between small text-muted"><strong>${c[1]}</strong><span>${date}</span></div><div style="color:#334155;">${c[4]}</div></div>`); 
                });
            });
        }

        function sendComment() {
            const txt = $('#commentInput').val();
            const code = $('#modalItemCode').val();
            const name = $('#modalItemNameHidden').val();
            if(!txt) return;
            
            $('#btnSend').text("...");
            fetch(SCRIPT_URL, {
                method: "POST", body: JSON.stringify({ action: "postComment", user: currentUser, itemCode: code, itemName: name, comment: txt })
            }).then(() => {
                $('#commentInput').val("");
                $('#btnSend').text("Kirim");
                loadComments(code);
            });
        }
    </script>
</body>
</html>
