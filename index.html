<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auxilium - Make PO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 1200px; margin-top: 90px; }
        
        /* Card Styling */
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 8px; }
        .card-header { border-bottom: 1px solid #eee; background-color: #fff; border-radius: 8px 8px 0 0 !important; }

        /* Form & Table Styling */
        .table-input { width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; }
        .bg-readonly { background-color: #e9ecef; cursor: not-allowed; }
        
        td { vertical-align: middle; }
        .col-no { width: 50px; text-align: center; }
        .col-action { width: 50px; text-align: center; }
        .col-qty { width: 120px; }
        .col-unit { width: 100px; }
        
        /* Navbar Styling */
        .nav-link { font-size: 0.95rem; color: #555; }
        .nav-link:hover { color: #198754; }
        .active-menu { background-color: #e9f7ef; color: #198754 !important; font-weight: 600; border-radius: 5px; }
        
        /* Dashed Button */
        .dashed-border { border-style: dashed; border-width: 2px; }
        .dashed-border:hover { background-color: #f8f9fa; border-style: solid; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold mb-0 h1" href="#">
                AUXILIUM <span class="fw-light fs-6">PO Entry System</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav align-items-center gap-1">
                    <li class="nav-item"><a class="nav-link px-3" href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/">Home PO</a></li>
                    <li class="nav-item"><a class="nav-link px-3" href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/polist/index.html">PO List</a></li>
                    <li class="nav-item"><a class="nav-link px-3" href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/entry/index.html">Receiving PO</a></li>
                    <li class="nav-item"><a class="nav-link px-3" href="https://accountingauxie.github.io/Auxilium-Portal-Sukses-Jaya/receiving/ImportXeroPO/index.html">Import Xero</a></li>
                    <li class="nav-item"><a class="nav-link px-3 active-menu" href="#">Make PO</a></li>
                    <li class="nav-item d-none d-lg-block mx-2 border-start" style="height: 24px;"></li>
                    <li class="nav-item">
                        <div id="connectionStatus" class="text-secondary small d-flex align-items-center ps-2">
                            <div class="spinner-border spinner-border-sm me-1" role="status"></div> Loading...
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mb-5">
        
        <div class="card p-4 mb-3">
            <div class="row align-items-end g-3">
                <div class="col-md-5">
                    <label class="fw-bold mb-1">Pilih Vendor</label>
                    <select class="form-select" id="vendorSelect" onchange="onVendorChange()">
                        <option value="" disabled selected>-- Tunggu Sebentar... --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="fw-bold mb-1">Tanggal PO</label>
                    <input type="date" class="form-control" id="poDate">
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-success fw-bold px-4 w-100 py-2" id="btnSimpan" onclick="submitPO()">
                        <i class="bi bi-save2 me-2"></i> SIMPAN PO
                    </button>
                </div>
            </div>
        </div>

        <div class="card p-0 overflow-hidden mb-4">
            <div class="table-responsive">
                <table class="table table-bordered mb-0" id="itemTable">
                    <thead class="table-light">
                        <tr>
                            <th class="col-no">#</th>
                            <th>Nama Item</th>
                            <th class="col-qty">Qty</th>
                            <th class="col-unit">Satuan</th>
                            <th>Catatan (Opsional)</th>
                            <th class="col-action"><i class="bi bi-trash"></i></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        </tbody>
                </table>
            </div>
            <div class="p-3 bg-light border-top text-center">
                <button class="btn btn-outline-primary fw-bold w-100 dashed-border" onclick="addNewRow()">
                    <i class="bi bi-plus-circle me-1"></i> Tambah Baris Item
                </button>
            </div>
        </div>

        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-bold text-secondary"><i class="bi bi-clock-history me-2"></i>Riwayat PO Terbaru</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadSavedPOs()" title="Refresh List"><i class="bi bi-arrow-clockwise"></i></button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ID PO</th>
                            <th>Tanggal PO</th>
                            <th>Vendor</th>
                            <th class="text-center">Jml Item</th>
                            <th>Status</th>
                            <th class="text-end">Waktu Input</th>
                        </tr>
                    </thead>
                    <tbody id="poHistoryBody">
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">
                                <div class="spinner-border spinner-border-sm text-secondary me-2"></div> Memuat data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ==========================================
        // URL WEB APP APPS SCRIPT
        const API_URL = "https://script.google.com/macros/s/AKfycbwS-8BhHKpme6oKV7W42bfQQ4oz32YWoWOoNTsKA41lebU8JYRbrjx2Wo-sXa-yEU1dBA/exec"; 
        // ==========================================

        var allData = {};

        // === 1. INITIALIZATION ===
        window.onload = function() {
            setDefaultDate();
            
            Swal.fire({
                title: 'Memuat Data',
                text: 'Menghubungkan ke database...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            // Fetch Data Vendor (Dropdown)
            fetch(API_URL + "?action=getData")
            .then(res => res.json())
            .then(res => {
                if(res.status === 'success'){
                    populateVendors(res.data);
                    document.getElementById("connectionStatus").innerHTML = '<span class="text-success fw-bold"><i class="bi bi-wifi"></i> Online</span>';
                }
                
                // Setelah vendor load, kita load riwayat PO
                loadSavedPOs(); 
                Swal.close();
            })
            .catch(e => {
                Swal.close();
                Swal.fire("Gagal Koneksi", "Tidak dapat mengambil data vendor. Cek koneksi internet.", "error");
                document.getElementById("connectionStatus").innerHTML = '<span class="text-danger">Offline/Error</span>';
            });
        };

        function setDefaultDate() {
            const date = new Date();
            // Mengatur default ke tanggal hari ini (Format YYYY-MM-DD)
            const jakartaDate = date.toLocaleDateString('en-CA', { timeZone: 'Asia/Jakarta' });
            document.getElementById("poDate").value = jakartaDate;
        }

        // === 2. VENDOR LOGIC ===
        function populateVendors(data) {
            allData = data;
            var select = document.getElementById("vendorSelect");
            select.innerHTML = '<option value="" disabled selected>-- Pilih Vendor --</option>';
            Object.keys(data).sort().forEach(v => {
                let opt = document.createElement("option");
                opt.value = v; opt.text = v;
                select.add(opt);
            });
        }

        function onVendorChange() {
            var tbody = document.getElementById("tableBody");
            tbody.innerHTML = ""; 
            addNewRow(); 
        }

        // === 3. ITEM TABLE LOGIC ===
        function addNewRow() {
            var vendor = document.getElementById("vendorSelect").value;
            if(!vendor) {
                if(Object.keys(allData).length > 0) Swal.fire("Pilih Vendor", "Silakan pilih vendor terlebih dahulu.", "warning");
                return;
            }

            var tbody = document.getElementById("tableBody");
            var rowIdx = tbody.children.length; 

            // Urutkan item secara alfabetis agar mudah dicari
            var itemList = allData[vendor].map((obj, idx) => ({...obj, originalIdx: idx}));
            itemList.sort((a, b) => a.item.localeCompare(b.item));

            var itemOptions = '<option value="" disabled selected>-- Cari Item --</option>';
            itemList.forEach(obj => {
                itemOptions += `<option value="${obj.originalIdx}">${obj.item}</option>`;
            });

            var tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="text-center bg-light row-number fw-bold">${rowIdx + 1}</td>
                <td>
                    <select class="form-select item-select" onchange="updateUnit(this)">${itemOptions}</select>
                </td>
                <td>
                    <input type="number" class="form-control qty-input" placeholder="0" min="0" oninput="validity.valid||(value='');">
                </td>
                <td><input type="text" class="form-control bg-readonly unit-input" readonly tabindex="-1"></td>
                <td><input type="text" class="form-control note-input" placeholder="Keterangan..."></td>
                <td class="text-center"><button class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-trash"></i></button></td>
            `;
            tbody.appendChild(tr);
        }

        function updateUnit(selectElement) {
            // --- CEK DUPLIKAT ---
            var selectedValue = selectElement.value;
            var allSelects = document.querySelectorAll(".item-select");
            var duplicateCount = 0;

            allSelects.forEach(el => {
                if(el.value === selectedValue && selectedValue !== "") {
                    duplicateCount++;
                }
            });

            if(duplicateCount > 1) {
                Swal.fire("Item Duplikat", "Item ini sudah dipilih di baris lain.", "warning");
                selectElement.value = ""; 
                var row = selectElement.closest("tr");
                row.querySelector(".unit-input").value = "";
                return; 
            }

            // --- ISI SATUAN OTOMATIS ---
            var vendor = document.getElementById("vendorSelect").value;
            var idx = selectElement.value; 
            var row = selectElement.closest("tr");
            var unitInput = row.querySelector(".unit-input");
            
            if(allData[vendor] && allData[vendor][idx]){
                unitInput.value = allData[vendor][idx].unit;
            }
        }

        function removeRow(btn) {
            btn.closest("tr").remove();
            renumberRows(); 
        }

        function renumberRows() {
            document.querySelectorAll("#tableBody tr .row-number").forEach((td, index) => td.innerText = index + 1);
        }

        // === 4. SUBMIT PO LOGIC ===
        function submitPO() {
            var vendor = document.getElementById("vendorSelect").value;
            var poDate = document.getElementById("poDate").value;

            if(!vendor) return Swal.fire("Error", "Pilih Vendor!", "error");
            if(!poDate) return Swal.fire("Error", "Tanggal PO harus diisi!", "error");

            var rows = document.querySelectorAll("#tableBody tr");
            if(rows.length === 0) return Swal.fire("Kosong", "Tambahkan item minimal satu.", "warning");

            var itemsToSave = [];
            var isValid = true;

            rows.forEach((row) => {
                var itemIdx = row.querySelector(".item-select").value;
                var qty = row.querySelector(".qty-input").value;
                var unit = row.querySelector(".unit-input").value;
                var note = row.querySelector(".note-input").value;

                if(!itemIdx || !qty || qty <= 0) {
                    isValid = false;
                    row.classList.add("table-danger"); 
                } else {
                    row.classList.remove("table-danger");
                    var realItemName = allData[vendor][itemIdx].item;
                    itemsToSave.push({ itemName: realItemName, qty: qty, unit: unit, note: note });
                }
            });

            if(!isValid) return Swal.fire("Data Belum Lengkap", "Cek baris yang merah (Item kosong atau Qty harus > 0).", "error");

            var btn = document.getElementById("btnSimpan");
            var originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Menyimpan...';

            fetch(API_URL + "?action=saveOrder", {
                method: "POST",
                body: JSON.stringify({ vendor: vendor, poDate: poDate, items: itemsToSave })
            })
            .then(res => res.json())
            .then(res => {
                if(res.status === 'success') {
                    Swal.fire({
                        title: 'Berhasil!',
                        text: 'PO ID: ' + res.id + ' telah disimpan.',
                        icon: 'success',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        // Reset Form
                        document.getElementById("vendorSelect").value = "";
                        document.getElementById("tableBody").innerHTML = "";
                        setDefaultDate();
                        
                        // REFRESH TABEL RIWAYAT
                        loadSavedPOs(); 
                    });
                } else {
                    throw new Error(res.message);
                }
            })
            .catch(err => Swal.fire('Gagal', err.message, 'error'))
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
        }

        // === 5. HISTORY PO LOGIC (NEW) ===
        function loadSavedPOs() {
            var tbody = document.getElementById("poHistoryBody");
            // Indikator loading halus (opacity) jika data sudah ada sebelumnya
            if(tbody.children.length > 0 && !tbody.querySelector(".spinner-border")) {
                tbody.style.opacity = "0.5";
            }

            fetch(API_URL + "?action=getSavedOrders")
            .then(res => res.json())
            .then(res => {
                if(res.status === 'success') {
                    renderHistoryTable(res.data);
                }
            })
            .catch(err => {
                console.error("Gagal load history:", err);
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Gagal memuat riwayat.</td></tr>`;
            })
            .finally(() => {
                tbody.style.opacity = "1";
            });
        }

        function renderHistoryTable(data) {
            var tbody = document.getElementById("poHistoryBody");
            tbody.innerHTML = "";

            if(data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-muted">Belum ada data PO.</td></tr>`;
                return;
            }

            data.forEach(po => {
                // Parsing tanggal agar cantik
                let dateObj = new Date(po.createdAt);
                let timeString = dateObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                let dateString = dateObj.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });

                let tr = document.createElement("tr");
                tr.innerHTML = `
                    <td class="fw-bold text-primary">${po.id}</td>
                    <td>${po.date}</td>
                    <td>${po.vendor}</td>
                    <td class="text-center"><span class="badge bg-secondary rounded-pill">${po.itemsCount}</span></td>
                    <td><span class="badge bg-warning text-dark border border-warning">${po.status}</span></td>
                    <td class="text-end small text-muted">${dateString} <i class="bi bi-clock ms-1"></i> ${timeString}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
