<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kas Kecil Modern</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        
        /* Floating Label Logic */
        .floating-input { 
            padding-top: 1.25rem; 
            padding-bottom: 0.25rem; 
        }
        .floating-label {
            position: absolute;
            top: 0.25rem;
            left: 0.75rem;
            font-size: 0.75rem;
            color: #94a3b8;
            transition: all 0.2s;
            pointer-events: none;
        }
        .peer:placeholder-shown ~ .floating-label {
            top: 0.75rem;
            font-size: 0.875rem;
            color: #64748b;
        }
        .peer:focus ~ .floating-label {
            top: 0.25rem;
            font-size: 0.75rem;
            color: #3b82f6;
        }
        
        /* Select2 Modern Override */
        .select2-container .select2-selection--single {
            height: 52px; /* Match floating input height */
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            padding-left: 12px;
            color: #334155;
            font-size: 0.875rem;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            top: 13px;
            right: 10px;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Modal Transitions */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 200ms, transform 200ms; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.95); transition: opacity 200ms, transform 200ms; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

<div id="loginPage" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-100">
        <div class="bg-white p-10 rounded-3xl shadow-2xl w-96 border border-slate-100 text-center">
            <div class="w-16 h-16 bg-blue-600 text-white rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-200">
                <i class="fas fa-wallet text-2xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Kas Kecil</h2>
            <p class="text-slate-400 text-sm mb-8">Sign in to manage expenses</p>
            
            <form onsubmit="handleLogin(event)" class="space-y-5 text-left">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Email Address</label>
                    <input type="email" id="email" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3.5 outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all text-sm font-medium text-slate-700" placeholder="nama@email.com" required>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Password</label>
                    <input type="password" id="password" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3.5 outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all text-sm font-medium text-slate-700" placeholder="••••••••" required>
                </div>

                <button type="submit" id="btnLogin" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl hover:bg-slate-800 transition shadow-lg shadow-slate-200 mt-4">Masuk</button>
            </form>
            
            <p id="loginError" class="text-red-500 text-xs mt-4 hidden font-medium bg-red-50 py-2 rounded-lg border border-red-100"></p>
        </div>
    </div>

    <div id="dashboardPage" class="hidden flex flex-col h-full relative">
        <header class="bg-white border-b border-slate-100 h-16 flex items-center justify-between px-6 flex-none z-20">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-slate-900 text-white rounded-lg flex items-center justify-center">
                    <i class="fas fa-coins text-sm"></i>
                </div>
                <h1 class="font-bold text-slate-700 text-lg tracking-tight">Kas Kecil</h1>
            </div>
            <div class="flex items-center gap-4">
                 <div id="lockStatus" class="hidden text-xs bg-red-50 text-red-600 px-3 py-1.5 rounded-full border border-red-100 font-medium">
                    <i class="fas fa-lock mr-1"></i> <span id="lockDateDisplay">-</span>
                </div>
                <div class="h-8 w-px bg-slate-200"></div>
                <div class="flex items-center gap-2">
                    <div class="text-right">
                        <p id="userName" class="text-xs font-bold text-slate-700">User</p>
                        <p class="text-[10px] text-slate-400">Admin</p>
                    </div>
                    <button onclick="logout()" class="w-8 h-8 rounded-full bg-slate-50 hover:bg-red-50 text-slate-400 hover:text-red-500 transition flex items-center justify-center">
                        <i class="fas fa-power-off text-xs"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="flex-grow flex overflow-hidden">
            <main id="mainContent" class="flex-grow overflow-y-auto p-6 transition-all duration-300">
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-8">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 group hover:shadow-md transition">
                        <div class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-1">Saldo Akhir</div>
                        <div class="text-2xl font-bold text-slate-800" id="valSaldo">...</div>
                        <div class="h-1 w-full bg-slate-100 mt-4 rounded-full overflow-hidden">
                            <div class="h-full bg-slate-800 w-full rounded-full"></div>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 group hover:shadow-md transition">
                        <div class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-1">Total Masuk</div>
                        <div class="text-2xl font-bold text-emerald-600" id="valDebit">...</div>
                        <div class="h-1 w-full bg-emerald-50 mt-4 rounded-full overflow-hidden">
                            <div class="h-full bg-emerald-500 w-0 transition-all duration-1000" style="width: 60%"></div>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 group hover:shadow-md transition">
                        <div class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-1">Total Keluar</div>
                        <div class="text-2xl font-bold text-rose-600" id="valKredit">...</div>
                        <div class="h-1 w-full bg-rose-50 mt-4 rounded-full overflow-hidden">
                            <div class="h-full bg-rose-500 w-0 transition-all duration-1000" style="width: 45%"></div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <div class="bg-white p-1.5 rounded-xl border border-slate-200 shadow-sm flex items-center gap-2">
                        <div class="relative group">
                            <input type="date" id="filterStart" onchange="fetchData()" class="bg-transparent text-xs font-medium text-slate-600 px-2 py-1.5 focus:outline-none cursor-pointer">
                            <span class="absolute -top-2 left-2 bg-white px-1 text-[9px] text-slate-400">Start</span>
                        </div>
                        <span class="text-slate-300">|</span>
                        <div class="relative group">
                            <input type="date" id="filterEnd" onchange="fetchData()" class="bg-transparent text-xs font-medium text-slate-600 px-2 py-1.5 focus:outline-none cursor-pointer">
                            <span class="absolute -top-2 left-2 bg-white px-1 text-[9px] text-slate-400">End</span>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="downloadCSV()" class="bg-white border border-slate-200 text-slate-600 hover:text-emerald-600 hover:border-emerald-200 px-4 py-2 rounded-xl text-xs font-semibold shadow-sm transition flex items-center gap-2">
                            <i class="fas fa-file-csv text-lg"></i> Export CSV
                        </button>
                        <button onclick="printPDF()" class="bg-white border border-slate-200 text-slate-600 hover:text-slate-900 hover:border-slate-300 px-4 py-2 rounded-xl text-xs font-semibold shadow-sm transition flex items-center gap-2">
                            <i class="fas fa-print text-lg"></i> PDF
                        </button>
                        <button onclick="openModal('add')" class="bg-slate-900 hover:bg-slate-800 text-white px-5 py-2 rounded-xl text-xs font-bold shadow-lg shadow-slate-200 transition flex items-center gap-2 transform hover:-translate-y-0.5">
                            <i class="fas fa-plus"></i> Transaksi Baru
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-slate-50/50 border-b border-slate-100 text-xs text-slate-400 uppercase tracking-wider">
                                    <th class="px-6 py-4 font-semibold">Tanggal</th>
                                    <th class="px-6 py-4 font-semibold">Ref</th>
                                    <th class="px-6 py-4 font-semibold">Deskripsi</th>
                                    <th class="px-6 py-4 font-semibold">Akun</th>
                                    <th class="px-6 py-4 font-semibold text-right">Nominal</th>
                                    <th class="px-6 py-4 font-semibold text-right">Saldo</th>
                                    <th class="px-6 py-4 font-semibold text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="text-sm text-slate-600"></tbody>
                        </table>
                    </div>
                    <div id="tableLoading" class="p-10 text-center hidden">
                        <i class="fas fa-circle-notch fa-spin text-slate-300 text-2xl"></i>
                        <p class="text-xs text-slate-400 mt-2">Memuat data...</p>
                    </div>
                </div>
                <div class="h-10"></div> </main>

            <aside id="previewPane" class="w-0 bg-white border-l border-slate-200 shadow-2xl transition-all duration-300 flex flex-col z-30">
                <div class="flex items-center justify-between p-4 border-b border-slate-100 bg-slate-50">
                    <span class="text-xs font-bold uppercase text-slate-500">Bukti Transaksi</span>
                    <button onclick="closePreview()" class="w-8 h-8 rounded-full hover:bg-slate-200 text-slate-400 transition flex items-center justify-center"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex-grow bg-slate-100 relative">
                     <iframe id="previewFrame" class="w-full h-full" src=""></iframe>
                </div>
                <div class="p-3 bg-white border-t border-slate-100 text-center">
                    <a id="btnNewTab" href="#" target="_blank" class="text-xs text-blue-600 font-semibold hover:underline">Buka di tab baru</a>
                </div>
            </aside>
        </div>
    </div>

    <div id="modalAdd" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col transform scale-100 transition-transform">
            
            <div class="px-8 py-5 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <div>
                    <h3 id="modalTitle" class="text-lg font-bold text-slate-800">Transaksi Baru</h3>
                    <p class="text-xs text-slate-400 mt-0.5">Isi detail transaksi dengan lengkap</p>
                </div>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-white border border-slate-200 text-slate-400 hover:text-slate-700 hover:border-slate-300 transition flex items-center justify-center shadow-sm">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>

            <div class="overflow-y-auto p-8 custom-scrollbar">
                <form id="addForm" onsubmit="submitTransaction(event)">
                    <input type="hidden" id="editRef">
                    <input type="hidden" id="formMode" value="add">

                    <div class="flex justify-center mb-8">
                        <div class="bg-slate-100 p-1 rounded-xl inline-flex relative w-full md:w-auto">
                            <div id="activeIndicator" class="absolute top-1 left-1 bottom-1 w-[calc(50%-4px)] bg-white rounded-lg shadow-sm transition-all duration-300 border border-slate-200/50"></div>
                            
                            <label class="relative z-10 w-full md:w-32 py-2 text-center text-xs font-bold cursor-pointer transition-colors duration-300 select-none text-rose-600" id="lblKeluar">
                                <input type="radio" name="tipe" value="Keluar" checked onchange="toggleType('Keluar')" class="hidden">
                                <i class="fas fa-arrow-up mr-1"></i> Expense
                            </label>
                            
                            <label class="relative z-10 w-full md:w-32 py-2 text-center text-xs font-bold cursor-pointer transition-colors duration-300 select-none text-slate-400" id="lblMasuk">
                                <input type="radio" name="tipe" value="Masuk" onchange="toggleType('Masuk')" class="hidden">
                                <i class="fas fa-arrow-down mr-1"></i> Income
                            </label>
                        </div>
                    </div>

                    <div class="grid grid-cols-12 gap-5">
                        
                        <div class="col-span-12 md:col-span-4 relative">
                            <input type="date" id="tgl" class="peer floating-input w-full bg-slate-50 border border-slate-200 rounded-lg px-3 outline-none focus:border-blue-500 focus:bg-white transition-all text-slate-700 font-medium h-[52px]">
                            <label class="floating-label">Tanggal Transaksi</label>
                        </div>
                        <div class="col-span-12 md:col-span-4 relative">
                            <input type="text" id="contact" class="peer floating-input w-full bg-slate-50 border border-slate-200 rounded-lg px-3 outline-none focus:border-blue-500 focus:bg-white transition-all text-slate-700 h-[52px]" placeholder=" ">
                            <label class="floating-label">Contact / Payee</label>
                        </div>
                        <div class="col-span-12 md:col-span-4 relative">
                             <select id="taxType" class="peer w-full bg-slate-50 border border-slate-200 rounded-lg px-3 outline-none focus:border-blue-500 focus:bg-white transition-all text-slate-700 h-[52px] text-sm appearance-none pt-4 pb-1">
                                <option value="">None</option>
                            </select>
                            <label class="floating-label">Tax Type</label>
                            <i class="fas fa-chevron-down absolute right-3 top-4 text-slate-400 text-xs pointer-events-none"></i>
                        </div>

                        <div class="col-span-12">
                            <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1 ml-1">Akun (CoA)</label>
                            <select id="akun" class="w-full"></select>
                        </div>

                       <div class="col-span-12 relative group">
    <textarea 
        id="desc" 
        rows="1" 
        class="peer w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-3 outline-none focus:border-blue-500 focus:bg-white transition-colors duration-200 text-slate-700 resize-none overflow-hidden" 
        placeholder=" " 
        oninput="autoResize(this)"></textarea>
    
    <label class="absolute left-3 -top-2.5 text-slate-400 text-xs bg-white px-1 transition-all 
                  peer-placeholder-shown:top-3 peer-placeholder-shown:text-sm peer-placeholder-shown:bg-transparent 
                  peer-focus:-top-2.5 peer-focus:text-xs peer-focus:bg-white peer-focus:px-1 peer-focus:text-blue-500 
                  pointer-events-none">
        Deskripsi Transaksi
    </label>
    
    <div class="absolute bottom-2 right-2 text-[10px] text-slate-300 opacity-0 group-hover:opacity-100 transition">
        <i class="fas fa-pen"></i>
    </div>
</div>

                        <div class="col-span-12 bg-slate-50 rounded-xl p-4 border border-slate-100 grid grid-cols-12 gap-4 items-center">
                            <div class="col-span-3">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Qty</label>
                                <input type="number" id="qty" value="1" min="1" oninput="calcTotal()" class="w-full bg-white border border-slate-200 rounded-lg px-2 py-2 text-center text-sm focus:border-blue-500 outline-none">
                            </div>
                            <div class="col-span-1 text-center text-slate-400 mt-4">x</div>
                            <div class="col-span-4">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Price</label>
                                <input type="number" id="price" oninput="calcTotal()" class="w-full bg-white border border-slate-200 rounded-lg px-2 py-2 text-sm focus:border-blue-500 outline-none" placeholder="0">
                            </div>
                             <div class="col-span-1 text-center text-slate-400 mt-4">=</div>
                            <div class="col-span-3">
                                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Total</label>
                                <input type="text" id="nominal" readonly class="w-full bg-slate-200/50 border border-slate-200 rounded-lg px-2 py-2 text-right font-bold text-slate-700 text-sm cursor-not-allowed">
                                <input type="hidden" id="nominalVal">
                            </div>
                        </div>

                        <div class="col-span-6 relative">
                            <input type="text" id="tagihan" class="peer floating-input w-full bg-slate-50 border border-slate-200 rounded-lg px-3 outline-none focus:border-blue-500 focus:bg-white transition-all text-slate-700 h-[52px]" placeholder=" ">
                            <label class="floating-label">No. Tagihan (Ref Lain)</label>
                        </div>
                        <div class="col-span-6 relative">
                            <label class="absolute -top-2 left-2 px-1 bg-white text-[10px] font-bold text-slate-400 z-10">Upload Bukti</label>
                            <input type="file" id="file" class="w-full text-xs text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-l-lg file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 border border-slate-200 rounded-lg cursor-pointer bg-slate-50 h-[52px] pt-1.5 pl-1.5">
                        </div>

                    </div>
                </form>
            </div>

            <div class="p-6 border-t border-slate-100 bg-slate-50/50">
                <button onclick="submitTransaction(event)" id="btnSubmit" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl shadow-xl shadow-slate-200 hover:bg-slate-800 transition transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                    <span id="btnText">Simpan Transaksi</span>
                </button>
            </div>
        </div>
    </div>

    <div id="printableArea" class="hidden">
        <h1 class="text-xl font-bold uppercase mb-2">Laporan Mutasi Kas Kecil</h1>
        <p class="text-xs mb-4" id="printInfo"></p>
        <table class="w-full text-xs border-collapse">
            <thead>
                <tr class="border-b-2 border-black">
                    <th class="text-left py-1 w-20">Date</th>
                    <th class="text-left py-1 w-24">Ref</th>
                    <th class="text-left py-1">Description</th>
                    <th class="text-right py-1 w-24">Debit</th>
                    <th class="text-right py-1 w-24">Credit</th>
                    <th class="text-right py-1 w-24">Balance</th>
                </tr>
            </thead>
            <tbody id="printBody"></tbody>
        </table>
    </div>

    <script>
        // API CONFIG
        // PASTIKAN GANTI URL DI BAWAH INI DENGAN URL DEPLOYMENT APPSCRIPT TERBARU
        const API_URL = "https://script.google.com/macros/s/AKfycbylqHZwW9X7aJa9x-3JGVUDEuWmlY1syioThBpZOLMfdrWZGOjKnF4OLBKomJgyIJe0/exec"; 
        
        let globalData = [];
        let accountData = { expense: [], income: [], tax: [] };
        let currentLock = null;

        // INIT
        $(document).ready(function() {
            checkSession();
            
            // Setup Date Filters Default (This Month)
            const d = new Date();
            const firstDay = new Date(d.getFullYear(), d.getMonth(), 1).toISOString().split('T')[0];
            const lastDay = new Date(d.getFullYear(), d.getMonth() + 1, 0).toISOString().split('T')[0];
            
            // Only set if empty
            if(!$('#filterStart').val()) $('#filterStart').val(firstDay);
            if(!$('#filterEnd').val()) $('#filterEnd').val(lastDay);

            $('#tgl').val(new Date().toISOString().split('T')[0]);

            $('#akun').select2({
                placeholder: "Pilih Akun",
                dropdownParent: $('#modalAdd'),
                width: '100%'
            });
        });

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // --- AUTH & DATA ---
        function checkSession() {
            const u = localStorage.getItem("kasUser");
            if(u) {
                $('#loginPage').addClass('hidden');
                $('#dashboardPage').removeClass('hidden');
                $('#userName').text(JSON.parse(u).name);
                fetchData();
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const b = $('#btnLogin');
            b.prop('disabled', true).text('Loading...');
            
            fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "login",
                    email: $('#email').val(),
                    password: $('#password').val()
                })
            }).then(r=>r.json()).then(d=>{
                if(d.status === "success") {
                    localStorage.setItem("kasUser", JSON.stringify(d.user));
                    checkSession();
                } else {
                    $('#loginError').text(d.message).removeClass('hidden');
                    b.prop('disabled', false).text('Masuk');
                }
            });
        }

        function logout() { localStorage.clear(); location.reload(); }

        function fetchData() {
            const start = $('#filterStart').val();
            const end = $('#filterEnd').val();
            
            $('#tableLoading').removeClass('hidden');
            $('#tableBody').empty();

            fetch(`${API_URL}?action=getData&start=${start}&end=${end}`)
            .then(r=>r.json())
            .then(d => {
                $('#tableLoading').addClass('hidden');
                if(d.status === "success") {
                    globalData = d.data; // Store for Export
                    
                    // Setup Accounts
                    accountData.expense = d.accounts.expense;
                    accountData.income = d.accounts.income;
                    accountData.tax = d.accounts.taxTypes;
                    currentLock = d.lockDate;

                    if(currentLock) {
                        $('#lockStatus').removeClass('hidden');
                        $('#lockDateDisplay').text(formatDateID(currentLock));
                    }

                    renderStats(d.stats);
                    renderTable(d.data);
                }
            });
        }

        // --- RENDERING ---
        function renderStats(s) {
            const fmt = n => "Rp " + new Intl.NumberFormat('id-ID').format(n);
            $('#valSaldo').text(fmt(s.saldo));
            $('#valDebit').text(fmt(s.debit));
            $('#valKredit').text(fmt(s.kredit));
        }

        function renderTable(rows) {
            const tb = $('#tableBody');
            if(rows.length === 0) {
                tb.html('<tr><td colspan="7" class="text-center py-8 text-slate-400">Tidak ada data di periode ini.</td></tr>');
                return;
            }

            const fmt = n => n===0 ? '-' : new Intl.NumberFormat('id-ID').format(n);
            const isLock = (dateISO) => currentLock && new Date(dateISO) <= new Date(currentLock);

            rows.forEach((r, i) => {
                let statusClass = "bg-slate-100 text-slate-500";
                let debit = "-", kredit = "-";
                
                if(r.debit > 0) debit = `<span class="text-emerald-600 font-bold">+ ${fmt(r.debit)}</span>`;
                if(r.kredit > 0) kredit = `<span class="text-rose-600 font-bold">- ${fmt(r.kredit)}</span>`;

                // Actions
                let locked = isLock(r.dateISO);
                
                // Edit Button Logic
                let btnEdit = locked ? 
                    `<span class="text-slate-300 cursor-not-allowed"><i class="fas fa-lock"></i></span>` :
                    `<button onclick="openModal('edit', ${i})" class="text-amber-400 hover:text-amber-600 transition"><i class="fas fa-pen"></i></button>`;
                
                // Delete Button Logic (NEW)
                let btnDelete = locked ?
                    `<span class="text-slate-300 cursor-not-allowed" title="Terkunci"><i class="fas fa-trash"></i></span>` :
                    `<button onclick="deleteTransaction('${r.ref}')" class="text-rose-400 hover:text-rose-600 transition" title="Hapus"><i class="fas fa-trash"></i></button>`;

                let btnView = r.attach ? `<button onclick="openPreview('${r.attach}')" class="text-blue-400 hover:text-blue-600"><i class="fas fa-eye"></i></button>` : '';
                
                let btnSync = "";
                if(r.kredit > 0) {
                    if(String(r.syncStatus).toLowerCase() === 'imported') {
                        btnSync = `<span class="text-emerald-400" title="Synced"><i class="fas fa-check-circle"></i></span>`;
                    } else {
                        btnSync = `<button onclick="sync('${r.ref}')" class="text-indigo-400 hover:text-indigo-600" title="Sync to Xero"><i class="fas fa-sync"></i></button>`;
                    }
                }

                const tr = `
                    <tr class="hover:bg-slate-50 border-b border-slate-100 transition">
                        <td class="px-6 py-4 whitespace-nowrap">${r.date}</td>
                        <td class="px-6 py-4 font-mono text-xs text-slate-500">${r.ref}</td>
                        <td class="px-6 py-4 truncate max-w-xs" title="${r.desc}">${r.desc}</td>
                        <td class="px-6 py-4 text-xs bg-slate-50 rounded mx-2">${r.account}</td>
                        <td class="px-6 py-4 text-right">${r.debit > 0 ? debit : kredit}</td>
                        <td class="px-6 py-4 text-right font-bold text-slate-700">${fmt(r.saldo)}</td>
                        <td class="px-6 py-4 text-center space-x-3">
                            ${btnView} ${btnEdit} ${btnDelete} ${btnSync}
                        </td>
                    </tr>
                `;
                tb.append(tr);
            });
        }

        // --- DELETE FUNCTION (NEW) ---
        function deleteTransaction(ref) {
            if(!confirm(`PERINGATAN!\n\nApakah Anda yakin ingin menghapus transaksi dengan Ref: ${ref}?\nTindakan ini tidak dapat dibatalkan.`)) return;

            // Tampilkan loading sederhana (optional: bisa dibuat lebih bagus)
            $('#tableLoading').removeClass('hidden');
            $('#tableBody').empty();

            fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "deleteTransaction",
                    ref: ref
                })
            })
            .then(r => r.json())
            .then(d => {
                alert(d.message);
                fetchData(); // Refresh data table
            })
            .catch(err => {
                alert("Error: " + err);
                fetchData();
            });
        }

        // --- MODAL LOGIC ---
        function toggleType(type) {
            const ind = $('#activeIndicator');
            const lblM = $('#lblMasuk');
            const lblK = $('#lblKeluar');
            const btn = $('#btnSubmit');

            if(type === 'Masuk') {
                ind.css('transform', 'translateX(100%)');
                lblM.removeClass('text-slate-400').addClass('text-emerald-600');
                lblK.removeClass('text-rose-600').addClass('text-slate-400');
                btn.removeClass('bg-slate-900').addClass('bg-emerald-600');
                populateCoa(accountData.income);
            } else {
                ind.css('transform', 'translateX(0)');
                lblK.removeClass('text-slate-400').addClass('text-rose-600');
                lblM.removeClass('text-emerald-600').addClass('text-slate-400');
                btn.removeClass('bg-emerald-600').addClass('bg-slate-900');
                populateCoa(accountData.expense);
            }
        }

        function populateCoa(list) {
            const s = $('#akun');
            s.empty();
            s.append(new Option('', ''));
            if(list) list.forEach(x => s.append(new Option(x.name, x.name)));
            s.trigger('change');
        }

        function populateTax() {
            const s = $('#taxType');
            s.empty().append('<option value="">None</option>');
            if(accountData.tax) accountData.tax.forEach(x => s.append(`<option value="${x}">${x}</option>`));
        }

        function calcTotal() {
            const q = parseFloat($('#qty').val()) || 0;
            const p = parseFloat($('#price').val()) || 0;
            const tot = q * p;
            $('#nominal').val("Rp " + new Intl.NumberFormat('id-ID').format(tot));
            $('#nominalVal').val(tot);
        }

        function openModal(mode, idx=null) {
            $('#modalAdd').removeClass('hidden');
            $('#addForm')[0].reset();
            populateTax();
            
            // Default State
            $('#qty').val(1);
            
            if(mode === 'add') {
                $('#modalTitle').text('Transaksi Baru');
                $('#formMode').val('add');
                $('#tgl').val(new Date().toISOString().split('T')[0]);
                $('input[name=tipe][value=Keluar]').prop('checked', true).trigger('change');
            } else {
                const d = globalData[idx];
                $('#modalTitle').text(`Edit ${d.ref}`);
                $('#formMode').val('edit');
                $('#editRef').val(d.ref);
                
                $('#tgl').val(d.dateISO);
                $('#desc').val(d.desc);
                $('#contact').val(d.contact);
                $('#taxType').val(d.taxType);
                $('#tagihan').val(d.noTagihan);
                
                // Set Values for Calc
                $('#qty').val(d.qty || 1);
                $('#price').val(d.price || 0);
                calcTotal();

                // Set Type
                const type = d.debit > 0 ? 'Masuk' : 'Keluar';
                $(`input[name=tipe][value=${type}]`).prop('checked', true).trigger('change');
                
                setTimeout(() => $('#akun').val(d.account).trigger('change'), 100);
            }
            // Auto resize textarea
            setTimeout(() => autoResize(document.getElementById('desc')), 100);
        }

        function closeModal() { $('#modalAdd').addClass('hidden'); }

        function submitTransaction(e) {
            e.preventDefault();
            // Validate
            const req = ['#tgl', '#contact', '#desc', '#nominalVal'];
            let valid = true;
            req.forEach(id => {
                if(!$(id).val()) { $(id).addClass('border-red-500'); valid=false; }
                else $(id).removeClass('border-red-500');
            });
            if(!$('#akun').val()) { alert("Pilih Akun!"); return; }
            if(!valid) return;

            const btn = $('#btnSubmit');
            const orig = $('#btnText').text();
            btn.prop('disabled', true);
            $('#btnText').text('Menyimpan...');

            const formData = {
                action: $('#formMode').val() === 'edit' ? 'editTransaction' : 'addTransaction',
                ref: $('#editRef').val(),
                tanggal: $('#tgl').val(),
                tipe: $('input[name=tipe]:checked').val(),
                akun: $('#akun').val(),
                deskripsi: $('#desc').val(),
                nominal: $('#nominalVal').val(),
                noTagihan: $('#tagihan').val(),
                contact: $('#contact').val(),
                taxType: $('#taxType').val(),
                qty: $('#qty').val(),
                price: $('#price').val()
            };

            const fileInput = document.getElementById('file');
            const send = (pl) => {
                fetch(API_URL, { method: "POST", body: JSON.stringify(pl) })
                .then(r=>r.json())
                .then(d=>{
                    if(d.status === "success") {
                        closeModal();
                        fetchData();
                    } else { alert(d.message); }
                })
                .finally(() => {
                    btn.prop('disabled', false);
                    $('#btnText').text(orig);
                });
            };

            if(fileInput.files.length > 0) {
                const r = new FileReader();
                r.onload = x => {
                    formData.fileData = x.target.result;
                    formData.fileName = fileInput.files[0].name;
                    send(formData);
                };
                r.readAsDataURL(fileInput.files[0]);
            } else { send(formData); }
        }

        function sync(ref) {
            if(!confirm("Sync ke Xero?")) return;
            fetch(API_URL, { method: "POST", body: JSON.stringify({action:'syncTransaction', ref:ref}) })
            .then(r=>r.json()).then(d=> { alert(d.message); fetchData(); });
        }

     // --- PREVIEW LOGIC (FIXED WIDTH 50%) ---
function openPreview(url) {
    // 1. Validasi URL & Fix Google Drive Link
    if(!url) return alert("Link file tidak valid");
    let previewUrl = url;
    if (url.includes("drive.google.com") && url.includes("/view")) {
        previewUrl = url.replace(/\/view.*/, "/preview");
    }

    // 2. Setup Elemen DOM
    const mainContent = document.getElementById("mainContent");
    const previewPane = document.getElementById("previewPane");
    const iframe = document.getElementById("previewFrame");
    const btnNewTab = document.getElementById("btnNewTab");
    
    // 3. Set Source & Link
    iframe.src = previewUrl;
    btnNewTab.href = url;

    // 4. Animasi Layout (Menggunakan Width Class Tailwind)
    // Hapus margin kanan paksa (mr-...) yang bikin layout rusak
    mainContent.classList.remove("mr-[50%]"); 
    
    // Transisi Lebar: Main Content mengecil, Preview membesar
    previewPane.classList.remove("w-0", "hidden");
    previewPane.classList.add("w-1/2"); // Preview jadi 50%
    
    // Kita paksa Main Content jadi 50% juga agar seimbang
    // Tapi karena ini Flexbox, biasanya cukup biarkan 'flex-grow' bekerja atau set explicit width
    // Cara paling aman dengan struktur HTML yang ada:
    mainContent.style.width = "50%"; 
}

function closePreview() {
    const mainContent = document.getElementById("mainContent");
    const previewPane = document.getElementById("previewPane");
    const iframe = document.getElementById("previewFrame");

    // Kembalikan Layout
    previewPane.classList.remove("w-1/2");
    previewPane.classList.add("w-0");
    
    // Kembalikan Main Content jadi Full Width
    mainContent.style.width = "100%";

    // Bersihkan Iframe setelah animasi selesai (300ms)
    setTimeout(() => {
        iframe.src = ""; 
        previewPane.classList.add("hidden"); 
    }, 300);
}

        // --- EXPORT FIX (POINT 2) ---
        // --- UPDATE FUNGSI EXPORT CSV ---
function downloadCSV() {
    // Cek apakah ada data
    if(!globalData || globalData.length === 0) return alert("Tidak ada data untuk diekspor");

    // 1. UPDATE HEADER: Tambahkan "Check Number" di akhir array
    const rows = [
        ["*Date", "*Amount", "Payee", "Description", "Reference", "Check Number"] 
    ];

    globalData.forEach(d => {
        // Hitung amount (+ untuk income, - untuk expense)
        let amt = d.debit > 0 ? d.debit : (d.kredit * -1);
        
        // Bersihkan tanda kutip ganda pada deskripsi agar CSV tidak error
        let desc = d.desc ? d.desc.replace(/"/g, '""') : "";
        let contact = d.contact ? d.contact.replace(/"/g, '""') : "";

        // 2. UPDATE DATA: Tambahkan string kosong "" di akhir untuk mengisi kolom Check Number
        rows.push([
            d.date,          // *Date
            amt,             // *Amount
            `"${contact}"`,  // Payee
            `"${desc}"`,     // Description
            d.ref,           // Reference
            ""               // Check Number (Dikosongkan default)
        ]);
    });

    // Proses pembuatan file CSV
    const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
    const link = document.createElement("a");
    link.href = encodeURI(csvContent);
    
    // Nama file dinamis sesuai filter tanggal
    link.download = `KasKecil_${$('#filterStart').val()}_${$('#filterEnd').val()}.csv`;
    
    document.body.appendChild(link);
    link.click();
    link.remove();
}

    // --- FIXED PRINT PDF FUNCTION ---
function printPDF() {
    // 1. Cek Data
    if (!globalData || globalData.length === 0) return alert("Tidak ada data untuk dicetak!");

    // 2. Siapkan Format Angka
    const fmt = n => n === 0 ? '-' : new Intl.NumberFormat('id-ID').format(n);
    const startDate = $('#filterStart').val();
    const endDate = $('#filterEnd').val();
    const user = JSON.parse(localStorage.getItem("kasUser") || "{}").name || "Admin";

    // 3. Generate Baris Tabel (HTML String)
    let rowsHtml = "";
    globalData.forEach(d => {
        let debitClass = d.debit > 0 ? "text-emerald-700 font-medium" : "text-gray-400";
        let kreditClass = d.kredit > 0 ? "text-rose-700 font-medium" : "text-gray-400";
        
        // Escape karakter khusus agar HTML tidak error
        const cleanDesc = d.desc.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

        rowsHtml += `
            <tr class="border-b border-gray-200 hover:bg-gray-50">
                <td class="py-2 pr-2 align-top whitespace-nowrap">${d.date}</td>
                <td class="py-2 px-2 align-top font-mono text-[10px] text-gray-500">${d.ref}</td>
                <td class="py-2 px-2 align-top">${cleanDesc}</td>
                <td class="py-2 px-2 align-top text-right ${debitClass}">${fmt(d.debit)}</td>
                <td class="py-2 px-2 align-top text-right ${kreditClass}">${fmt(d.kredit)}</td>
                <td class="py-2 pl-2 align-top text-right font-bold text-gray-800">${fmt(d.saldo)}</td>
            </tr>
        `;
    });

    // 4. Buat Halaman HTML Baru (Isolated Environment)
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Laporan Kas Kecil</title>
            <script src="https://cdn.tailwindcss.com"><\/script>
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
                body { font-family: 'Inter', sans-serif; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                @page { size: A4; margin: 1cm; }
            </style>
        </head>
        <body class="p-8 text-gray-800">
            <div class="mb-8 border-b-2 border-gray-800 pb-4 flex justify-between items-end">
                <div>
                    <h1 class="text-2xl font-bold uppercase tracking-wide text-gray-900">Laporan Mutasi Kas</h1>
                    <p class="text-sm text-gray-500 mt-1">Periode: <span class="font-semibold text-gray-700">${startDate}</span> s/d <span class="font-semibold text-gray-700">${endDate}</span></p>
                </div>
                <div class="text-right text-xs text-gray-400">
                    <p>Printed by: ${user}</p>
                    <p>Date: ${new Date().toLocaleString('id-ID')}</p>
                </div>
            </div>

            <table class="w-full text-xs border-collapse">
                <thead>
                    <tr class="border-b-2 border-gray-300 bg-gray-50">
                        <th class="py-3 pr-2 text-left font-bold text-gray-600 uppercase w-20">Tanggal</th>
                        <th class="py-3 px-2 text-left font-bold text-gray-600 uppercase w-24">Ref</th>
                        <th class="py-3 px-2 text-left font-bold text-gray-600 uppercase">Deskripsi</th>
                        <th class="py-3 px-2 text-right font-bold text-gray-600 uppercase w-24">Masuk</th>
                        <th class="py-3 px-2 text-right font-bold text-gray-600 uppercase w-24">Keluar</th>
                        <th class="py-3 pl-2 text-right font-bold text-gray-600 uppercase w-28">Saldo</th>
                    </tr>
                </thead>
                <tbody>
                    ${rowsHtml}
                </tbody>
            </table>

            <div class="mt-8 flex justify-end">
                <div class="w-1/3 bg-gray-50 p-4 rounded border border-gray-200">
                    <div class="flex justify-between text-xs mb-2">
                        <span class="text-gray-500">Total Masuk</span>
                        <span class="font-bold text-emerald-600">${$("#valDebit").text()}</span>
                    </div>
                    <div class="flex justify-between text-xs mb-2">
                        <span class="text-gray-500">Total Keluar</span>
                        <span class="font-bold text-rose-600">${$("#valKredit").text()}</span>
                    </div>
                    <div class="border-t border-gray-300 my-2"></div>
                    <div class="flex justify-between text-sm font-bold">
                        <span>Saldo Akhir</span>
                        <span>${$("#valSaldo").text()}</span>
                    </div>
                </div>
            </div>

            <script>
                // Tunggu sebentar agar Tailwind load, lalu print
                setTimeout(() => {
                    window.print();
                    // window.close(); // Opsional: tutup otomatis setelah print
                }, 800);
            <\/script>
        </body>
        </html>
    `;

    // 5. Eksekusi Popup
    const popup = window.open('', '_blank', 'width=1000,height=800');
    popup.document.open();
    popup.document.write(printContent);
    popup.document.close();
}

        function formatDateID(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
        }
    </script>
</body>
</html>
