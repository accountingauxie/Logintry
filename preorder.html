<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COGS Generator Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .loader {
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #3b82f6; 
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .tab-active { border-bottom: 2px solid #0EA5E9; color: #0EA5E9; font-weight: 600; }
        .tab-inactive { color: #64748B; hover:text-gray-800; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-6 z-20 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-slate-800 text-white p-1.5 rounded">
                <i class="fa-solid fa-layer-group text-lg"></i>
            </div>
            <div>
                <h1 class="font-bold text-gray-800 text-lg tracking-tight">COGS <span class="text-blue-600">MANAGER</span></h1>
                <p class="text-[10px] text-gray-500 -mt-1 uppercase tracking-wider">Automated System</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="text-right hidden md:block">
                <p class="text-xs font-bold text-gray-700">Admin Gudang</p>
                <p class="text-[10px] text-green-500 font-semibold">‚óè Online</p>
            </div>
            <div class="h-8 w-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold text-xs">
                AG
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col">
            <div class="p-4">
                <p class="text-xs font-semibold text-gray-400 uppercase mb-3 px-2">Main Menu</p>
                <nav class="space-y-1">
                    <button onclick="switchView('orders')" id="nav-orders" class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md bg-blue-50 text-blue-700">
                        <i class="fa-solid fa-file-invoice w-5 text-center"></i> Review Penjualan
                    </button>
                    <button onclick="switchView('inventory')" id="nav-inventory" class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 hover:text-gray-900">
                        <i class="fa-solid fa-boxes-stacked w-5 text-center"></i> Stok Gudang
                    </button>
                </nav>
            </div>
            <div class="mt-auto p-4 border-t border-gray-100">
                <div class="bg-gray-50 rounded p-3 text-xs text-gray-500">
                    <p class="font-semibold mb-1">Server Status</p>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-500 rounded-full"></span> Connected
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 bg-gray-50 overflow-y-auto p-6 relative">
            
            <div id="loading" class="hidden absolute inset-0 bg-white/70 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-3"></div>
                <p class="text-sm text-gray-600 font-medium animate-pulse">Menghubungkan ke Google Sheets...</p>
            </div>

            <div class="mb-6 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800" id="page-title">Review Penjualan</h2>
                    <p class="text-sm text-gray-500">Kelola dan hitung HPP untuk invoice yang masuk.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="refreshData()" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 shadow-sm transition-all flex items-center gap-2">
                        <i class="fa-solid fa-rotate"></i> Refresh
                    </button>
                </div>
            </div>

            <div id="view-orders" class="space-y-4">
                
                <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex flex-col md:flex-row gap-4">
                    <div class="flex-1 relative">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-gray-400 text-sm"></i>
                        <input type="text" id="searchInput" placeholder="Cari No Order / Customer..." class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="flex gap-2">
                        <select class="border border-gray-300 rounded-md text-sm px-3 py-2 bg-gray-50 text-gray-500 cursor-not-allowed" disabled>
                            <option>All Types</option>
                        </select>
                        <input type="date" class="border border-gray-300 rounded-md text-sm px-3 py-2 bg-gray-50 text-gray-500 cursor-not-allowed" disabled>
                    </div>
                </div>

                <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Order #</th>
                                    <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Customer</th>
                                    <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Items Qty</th>
                                    <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body" class="divide-y divide-gray-100 text-sm text-gray-700">
                                </tbody>
                        </table>
                    </div>
                    <div id="orders-empty" class="hidden flex flex-col items-center justify-center py-12 text-center">
                        <div class="bg-gray-100 p-4 rounded-full mb-3">
                            <i class="fa-regular fa-clipboard text-2xl text-gray-400"></i>
                        </div>
                        <h3 class="text-gray-900 font-medium">Tidak ada data ditemukan</h3>
                        <p class="text-gray-500 text-xs mt-1">Coba refresh atau ubah kata kunci pencarian.</p>
                    </div>
                </div>
            </div>

            <div id="view-inventory" class="hidden space-y-4">
                <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase w-1/3">Item Name</th>
                                <th class="px-6 py-3 text-xs font-semibold text-gray-500 uppercase">Available Batches (FIFO)</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body" class="divide-y divide-gray-100">
                            </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- KONFIGURASI ---
        const API_URL = "https://script.google.com/macros/s/AKfycbyzCDAJwO3rjdA1gYOvSmBj8MwkVQhE_d-L-4OFUBJwO-vwNFTiyXdSWoLIVgZFlxdy/exec";
        
        // State
        let ordersData = [];
        let currentView = 'orders';

        document.addEventListener('DOMContentLoaded', () => {
            fetchOrders();
            
            // Search Listener
            document.getElementById('searchInput').addEventListener('keyup', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = ordersData.filter(o => 
                    o.invoice.toLowerCase().includes(term) || 
                    o.customer.toLowerCase().includes(term)
                );
                renderOrders(filtered);
            });
        });

        // --- NAVIGATION ---
        function switchView(view) {
            currentView = view;
            const title = document.getElementById('page-title');
            
            if (view === 'orders') {
                document.getElementById('view-orders').classList.remove('hidden');
                document.getElementById('view-inventory').classList.add('hidden');
                document.getElementById('nav-orders').classList.add('bg-blue-50', 'text-blue-700');
                document.getElementById('nav-orders').classList.remove('text-gray-600');
                document.getElementById('nav-inventory').classList.remove('bg-blue-50', 'text-blue-700');
                document.getElementById('nav-inventory').classList.add('text-gray-600');
                title.innerText = "Review Penjualan";
                if(ordersData.length === 0) fetchOrders();
            } else {
                document.getElementById('view-orders').classList.add('hidden');
                document.getElementById('view-inventory').classList.remove('hidden');
                document.getElementById('nav-inventory').classList.add('bg-blue-50', 'text-blue-700');
                document.getElementById('nav-inventory').classList.remove('text-gray-600');
                document.getElementById('nav-orders').classList.remove('bg-blue-50', 'text-blue-700');
                document.getElementById('nav-orders').classList.add('text-gray-600');
                title.innerText = "Stok Gudang";
                fetchInventory();
            }
        }

        function refreshData() {
            if(currentView === 'orders') fetchOrders();
            else fetchInventory();
        }

        // --- FETCH ORDERS ---
        async function fetchOrders() {
            setLoading(true);
            try {
                const res = await fetch(`${API_URL}?action=getOrders`);
                const data = await res.json();
                ordersData = data;
                renderOrders(data);
            } catch (err) {
                console.error(err);
                Swal.fire('Connection Error', 'Gagal mengambil data dari Google Sheet.', 'error');
            } finally {
                setLoading(false);
            }
        }

        function renderOrders(data) {
            const tbody = document.getElementById('orders-table-body');
            const emptyState = document.getElementById('orders-empty');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            data.forEach(order => {
                // Prepare tooltip for items
                const itemDetails = order.items.map(i => `${i.item} (x${i.qty})`).join('\n');
                const totalQty = order.items.reduce((acc, curr) => acc + Number(curr.qty), 0);

                const row = `
                    <tr class="hover:bg-blue-50/50 transition-colors group">
                        <td class="px-6 py-4 font-medium text-blue-600">
                            ${order.invoice}
                        </td>
                        <td class="px-6 py-4 text-gray-500">${order.date}</td>
                        <td class="px-6 py-4 font-medium text-gray-800">${order.customer}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2 cursor-help" title="${itemDetails}">
                                <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold border border-gray-200">
                                    ${totalQty} Items
                                </span>
                                <i class="fa-solid fa-circle-info text-gray-300 text-xs"></i>
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                                Pending COGS
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="processCOGS('${order.invoice}')" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-2 px-4 rounded shadow-sm hover:shadow transition-all flex items-center gap-2 ml-auto">
                                <i class="fa-solid fa-calculator"></i> Generate
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // --- FETCH INVENTORY ---
        async function fetchInventory() {
            setLoading(true);
            try {
                const res = await fetch(`${API_URL}?action=getInventory`);
                const data = await res.json();
                renderInventory(data);
            } catch (err) {
                console.error(err);
            } finally {
                setLoading(false);
            }
        }

        function renderInventory(data) {
            const tbody = document.getElementById('inventory-table-body');
            tbody.innerHTML = '';
            
            const items = Object.entries(data);
            if (items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="2" class="px-6 py-8 text-center text-gray-500">Inventory kosong.</td></tr>`;
                return;
            }

            items.forEach(([name, batches]) => {
                const badgeHtml = batches.map(b => `
                    <span class="inline-flex items-center gap-1.5 bg-white border border-gray-200 text-gray-600 text-xs px-2.5 py-1.5 rounded shadow-sm mr-2 mb-2">
                        <i class="fa-regular fa-clock text-gray-400"></i> ${b.date}
                        <span class="border-l border-gray-200 pl-1.5 ml-1 font-bold text-blue-600">Qty: ${b.qty}</span>
                    </span>
                `).join('');

                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-800 align-top">${name}</td>
                        <td class="px-6 py-4 align-top">
                            <div class="flex flex-wrap">${badgeHtml}</div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // --- ACTION: CALCULATE COGS ---
        async function processCOGS(invoice) {
            const result = await Swal.fire({
                title: 'Generate COGS?',
                html: `Sistem akan menghitung HPP untuk <b>${invoice}</b> dan memotong stok (FIFO).`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#2563EB',
                cancelButtonColor: '#94A3B8',
                confirmButtonText: 'Ya, Hitung Sekarang',
                cancelButtonText: 'Batal',
                reverseButtons: true
            });

            if (result.isConfirmed) {
                setLoading(true);
                try {
                    // Send POST request (No-CORS safe method)
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'calculate', invoice: invoice })
                    });
                    
                    const resData = await response.json();

                    if(resData.success) {
                        await Swal.fire({
                            icon: 'success',
                            title: 'Berhasil!',
                            text: `COGS untuk ${invoice} telah dihitung.`,
                            timer: 2000,
                            showConfirmButton: false
                        });
                        fetchOrders(); // Reload list
                    } else {
                        Swal.fire('Gagal', resData.message || 'Terjadi kesalahan.', 'error');
                    }
                } catch (error) {
                    Swal.fire('Error', 'Gagal menghubungi server.', 'error');
                } finally {
                    setLoading(false);
                }
            }
        }

        function setLoading(state) {
            const el = document.getElementById('loading');
            if(state) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }
    </script>
</body>
</html>
